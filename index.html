<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>briefnews - AI News Digest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .container {
            max-width: 100%;
            overflow-x: hidden;
        }
        .news-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.3s ease-in-out;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 100%; 
        }
        .news-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .breaking-news {
            border-left: 4px solid #dc3545;
            background: linear-gradient(90deg, rgba(220,53,69,0.1) 0%, rgba(255,255,255,1) 10%);
        }
        .feed-source { color: #5f6368; }
        .category-tag {
            background-color: #e8f0fe; color: #1a73e8;
            font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem;
        }
        .breaking-tag {
            background-color: #dc3545; color: white;
            font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem;
            font-weight: bold; text-transform: uppercase;
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #1a73e8;
            border-radius: 50%; width: 80px; height: 80px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #bbb; width: 90%; max-width: 450px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-close-button { color: #888; float: right; font-size: 24px; font-weight: bold; line-height: 0.8; }
        .modal-close-button:hover, .modal-close-button:focus { color: #333; text-decoration: none; cursor: pointer; }

        #toastContainer { position: fixed; bottom: 15px; right: 15px; z-index: 1001; display: flex; flex-direction: column; align-items: flex-end; }
        .toast {
            background-color: #333; color: #fff;
            padding: 10px 15px; border-radius: 5px; margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(15px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            font-size: 0.85rem; max-width: 300px; word-wrap: break-word;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: #c82333; }
        .toast.success { background-color: #218838; }
        .toast.info { background-color: #0069d9; }
        
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #1f2937;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .scroll-to-top:hover {
            background: #374151;
            transform: translateY(-2px);
        }
        
        .audio-fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 18px;
        }
        
        .audio-fab:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .settings-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .blocked-term-pill {
            display: inline-flex; align-items: center;
            background-color: #e0e0e0; color: #333;
            padding: 5px 10px; margin: 3px; border-radius: 16px; font-size: 0.85rem;
        }
        .blocked-term-pill button {
            background: none; border: none; color: #777; margin-left: 8px;
            font-weight: bold; cursor: pointer; padding: 0; line-height: 1;
        }
        .blocked-term-pill button:hover { color: #333; }
        .page { display: none; }
        .page.active { display: block; }

        .form-input {
            width: 100%; padding: 0.5rem 0.75rem; font-size: 0.9rem;
            border: 1px solid #ced4da; border-radius: 0.25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .form-input:focus {
            border-color: #80bdff; outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .btn {
            display: inline-block; font-weight: 500; color: #fff; text-align: center;
            vertical-align: middle; cursor: pointer; user-select: none;
            background-color: #007bff; border: 1px solid #007bff;
            padding: 0.5rem 1rem; font-size: 0.9rem; line-height: 1.5;
            border-radius: 0.25rem; transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .btn:hover { background-color: #0056b3; border-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; border-color: #545b62; }
        
        .category-button.selected {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Mobile image fixes */
        @media (max-width: 768px) {
            .news-card .flex {
                flex-direction: column;
            }
            
            .news-card .flex-shrink-0:has(img) {
                margin-left: 0 !important;
                margin-right: 0 !important;
                margin-bottom: 1rem;
                width: 100%;
                order: 2;
            }
            
            .news-card .flex-grow {
                order: 1;
            }
            
            .news-card img {
                width: 100% !important;
                height: 200px !important;
                max-width: none !important;
            }
        }
        
        .app-title-brief { color: #a0d2eb; }
        .app-title-news { color: #ffffff; }
        
        .category-button.selected {
            background: linear-gradient(to right, #059669, #065f46) !important;
            color: white !important;
            border-color: #065f46 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }


    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-700 text-white shadow-md sticky top-0 z-50">
        <div class="w-full px-2 sm:px-4 py-2 sm:py-3 flex justify-between items-center min-w-0">
            <h1 onclick="window.location.href = window.location.origin + window.location.pathname" class="text-lg sm:text-xl md:text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity flex-shrink-0">
                <span class="app-title-brief">brief</span><span class="app-title-news">news</span>
            </h1>
            <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
                <button id="headerNewsletterBtn" onclick="generateCustomNewsletter()" 
                        class="hidden px-2 py-1 bg-green-600 text-white rounded text-xs sm:text-sm font-medium hover:bg-green-700 transition-colors whitespace-nowrap">
                    Generate Newsletter
                </button>
                <a href="https://github.com/davidsnyder-nc/briefnews" target="_blank" rel="noopener noreferrer" 
                   class="flex items-center p-2 rounded-md hover:bg-blue-800 transition-colors" 
                   title="View on GitHub">
                    <svg class="w-5 h-5 fill-current text-white" viewBox="0 0 24 24">
                        <path d="M12 0C5.374 0 0 5.373 0 12 0 17.302 3.438 21.8 8.207 23.387c.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                <button id="navNews" onclick="window.location.href = window.location.origin + window.location.pathname" class="flex items-center gap-1 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-blue-800 focus:outline-none focus:bg-blue-800">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
                        <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M7 7H17M7 11H17M7 15H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span class="hidden sm:inline">News</span>
                </button>
                <button id="navSettings" class="flex items-center gap-1 px-2 py-1 sm:px-3 sm:py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-blue-800 focus:outline-none focus:bg-blue-800">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
                        <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M12 6V2M12 22V18M18 12H22M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.24 7.76L18.36 5.64M5.64 18.36L7.76 16.24M16.24 16.24L18.36 18.36M5.64 5.64L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span class="hidden sm:inline">Settings</span>
                </button>
            </div>
        </div>
    </nav>




    <div id="newsPage" class="page active w-full max-w-full px-2 sm:px-4 py-4 overflow-x-hidden">
        <!-- Hidden select for backward compatibility -->
        <select id="categorySelect" style="display: none;">
            <option value="all">All Categories</option>
        </select>

        <div id="statusArea" class="text-center mb-4">
            <p id="statusMessage" class="text-gray-600"></p>
            <div id="loader" class="loader hidden"></div>
        </div>

        <div id="welcomeSection" class="mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg p-8 mb-6 relative overflow-hidden">
                <!-- Enormous background icon -->
                <div class="absolute inset-0 flex items-center justify-end pointer-events-none">
                    <div class="opacity-25 transform translate-x-20">
                        <svg width="400" height="400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 6C4 4.89543 4.89543 4 6 4H18C19.1046 4 20 4.89543 20 6V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6Z" fill="white" fill-opacity="0.5"/>
                            <path d="M8 8H16M8 12H16M8 16H12" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Content overlay -->
                <div class="relative z-10">
                    <div>
                        <h2 class="text-3xl font-bold mb-4">Today's news on demand</h2>
                        <p class="text-lg mb-4">Your AI-powered news digest from only trusted sources</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                    <div class="bg-white bg-opacity-95 rounded-lg p-4 shadow-sm border border-white border-opacity-30">
                        <h3 class="font-semibold text-lg text-blue-800">Smart Summaries</h3>
                        <p class="text-sm text-blue-600">Optional AI-generated summaries tailored to your preferences</p>
                    </div>
                    <div class="bg-white bg-opacity-95 rounded-lg p-4 shadow-sm border border-white border-opacity-30">
                        <h3 class="font-semibold text-lg text-blue-800">Breaking News Priority</h3>
                        <p class="text-sm text-blue-600">Important updates appear first automatically</p>
                    </div>
                    <div class="bg-white bg-opacity-95 rounded-lg p-4 shadow-sm border border-white border-opacity-30">
                        <h3 class="font-semibold text-lg text-blue-800">Multiple Categories</h3>
                        <p class="text-sm text-blue-600">Technology, Business, Science, Sports, and more</p>
                    </div>
                    <div class="bg-white bg-opacity-95 rounded-lg p-4 shadow-sm border border-white border-opacity-30">
                        <h3 class="font-semibold text-lg text-blue-800">Custom Newsletters</h3>
                        <p class="text-sm text-blue-600">Export personalized newsletters with audio playback</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Start</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-full">
                        <h4 class="font-medium text-gray-700 mb-3">Choose Your News Categories</h4>
                        <p class="text-xs text-gray-500 mb-3">Select categories. Multiple selections may yield more results.</p>
                        <div class="flex flex-wrap gap-3" id="categoryButtons">
                            <!-- Dynamic category buttons will be populated here -->
                        </div>
                        <div class="mt-4 text-center">
                            <button id="generateFromSelection" onclick="generateFromSelectedCategories()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors shadow-sm" style="display: none;">Generate News from Selected Categories</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Article Index (hidden by default) -->
        <div id="articleIndex" class="bg-gray-50 rounded-lg p-3 mb-4 text-xs" style="display: none;">
            <h3 class="font-semibold text-gray-700 mb-2">Article Index:</h3>
            <div id="indexList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-1 text-gray-600">
            </div>
        </div>



        <main id="newsletterArea" class="grid grid-cols-1 gap-6">
            </main>
    </div>

    <div id="settingsPage" class="page container mx-auto px-4 py-4" style="display: none;">
        <h2 class="text-2xl font-semibold mb-6 text-gray-700">Settings</h2>
        
        <!-- Privacy Notice -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <h3 class="text-sm font-medium text-blue-800 mb-1">Privacy & Data Storage</h3>
                    <p class="text-sm text-blue-700">No account required. All settings are saved locally in your browser only. Absolutely no data is shared with servers or stored externally. Your privacy is completely protected.</p>
                </div>
            </div>
        </div>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">AI Provider Configuration</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="aiProvider" class="form-label">AI Provider:</label>
                    <select id="aiProvider" class="form-input">
                        <option value="gemini" selected>Google Gemini</option>
                        <option value="openai">OpenAI ChatGPT</option>
                    </select>
                </div>
                <div id="geminiConfig">
                    <label for="geminiApiKey" class="form-label">Gemini API Key:</label>
                    <input type="password" id="geminiApiKey" class="form-input" placeholder="Enter your Gemini API Key" autocomplete="off" data-form-type="other">
                    <p class="text-xs text-gray-500 mt-1">Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
                    <p class="text-xs text-blue-600 mt-1">Note: This API key will also be used for Google Text-to-Speech features</p>
                </div>
                <div id="openaiConfig" style="display: none;">
                    <label for="openaiApiKey" class="form-label">OpenAI API Key:</label>
                    <input type="password" id="openaiApiKey" class="form-input" placeholder="Enter your OpenAI API Key" autocomplete="off" data-form-type="other">
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a></p>
                </div>
            </div>

        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">RSS Feeds (OPML)</h3>
            <p class="text-xs text-gray-500 mb-2">Upload an OPML file for custom RSS feeds. Cleared OPML uses defaults.</p>
            <input type="file" id="opmlFile" accept=".opml,.xml" class="form-input mb-2">
            <div id="opmlFileInfo" class="text-sm text-gray-600 mb-2"></div>
            <button id="clearOpml" class="btn btn-secondary btn-sm">Clear Uploaded OPML</button>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Blocked Terms</h3>
            <p class="text-xs text-gray-500 mb-2">Block news containing these terms. Enter term and press Enter to add.</p>
            <input type="text" id="blockedTermInput" class="form-input mb-2" placeholder="Enter term to block...">
            <div id="blockedTermsList" class="min-h-6"></div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Newsletter Settings</h3>
            <div class="mt-4">
                <label class="flex items-center">
                    <input type="checkbox" id="aiRewrite" class="mr-2">
                    <span>AI Rewrite: Transform articles into polished, easy-to-read stories</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">When enabled, AI will completely rewrite news articles for better clarity and engagement rather than just summarizing them.</p>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">AI Processing Style</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="aiStyle" class="form-label">Writing Style:</label>
                    <select id="aiStyle" class="form-input">
                        <option value="professional" selected>Professional & Neutral</option>
                        <option value="conversational">Conversational & Engaging</option>
                        <option value="analytical">Analytical & In-depth</option>
                        <option value="simple">Simple & Easy to Read</option>
                    </select>
                </div>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Custom AI Prompt</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="customPrompt" class="form-label">AI Prompt Template:</label>
                    <textarea id="customPrompt" class="form-input h-24" placeholder="Enter custom AI prompt template...">{article.title}

Write ONE paragraph summary.</textarea>
                    <p class="text-xs text-gray-500 mt-1">Use {article.title} and {article.description} as placeholders. Leave blank to use default prompts.</p>
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Local News Configuration</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="zipCode" class="form-label">Zip Code for Local News:</label>
                    <input type="text" id="zipCode" placeholder="Enter your zip code (e.g., 10001)" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-sm text-gray-500 mt-1">Used to fetch local news from Google News and regional sources</p>
                </div>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Display Preferences</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="form-label">Article Layout:</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center">
                            <input type="radio" name="viewMode" value="row" id="viewModeRow" class="mr-2" checked>
                            <span>Row View</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="viewMode" value="grid" id="viewModeGrid" class="mr-2">
                            <span>Grid View</span>
                        </label>
                    </div>
                </div>
                <label class="flex items-center">
                    <input type="checkbox" id="showSourceInfo" class="mr-2" checked>
                    <span>Show source information</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="showCategories" class="mr-2" checked>
                    <span>Show category tags</span>
                </label>
            </div>
        </section>
        <div class="text-center">
            <button id="saveAllSettings" class="btn bg-green-600 border-green-600 hover:bg-green-700 hover:border-green-700 px-6 py-2">
                Save All Settings
            </button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <div id="saveConfirmModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h3 class="text-lg font-semibold mb-4">Settings Saved</h3>
            <p class="mb-4">Your settings have been saved successfully!</p>
            <button id="modalOkButton" class="btn">OK</button>
        </div>
    </div>

    <script>
        const DEFAULT_OPML = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
<head>
    <title>Verified RSS Feeds - Expanded</title>
    <dateCreated>Sun, 01 Jun 2025 11:16:00 GMT</dateCreated>
</head>
<body>
    <outline text="Feeds" title="Feeds">
        <outline text="General News" title="General News">
            <outline text="The New York Times" type="rss" xmlUrl="https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml"/>
            <outline text="CNN Top Stories" type="rss" xmlUrl="http://rss.cnn.com/rss/cnn_topstories.rss"/>
            <outline text="NPR News" type="rss" xmlUrl="https://feeds.npr.org/1001/rss.xml"/>
            <outline text="CBS News" type="rss" xmlUrl="https://www.cbsnews.com/latest/rss/main"/>
            <outline text="Associated Press" type="rss" xmlUrl="https://feeds.apnews.com/rss/apf-topnews"/>
        </outline>
        <outline text="Technology" title="Technology">
            <outline text="TechCrunch" type="rss" xmlUrl="https://techcrunch.com/feed/"/>
            <outline text="WIRED" type="rss" xmlUrl="https://www.wired.com/feed/rss"/>
            <outline text="The Verge" type="rss" xmlUrl="https://www.theverge.com/rss/index.xml"/>
            <outline text="CNET News" type="rss" xmlUrl="https://www.cnet.com/rss/news/"/>
            <outline text="Ars Technica" type="rss" xmlUrl="http://feeds.arstechnica.com/arstechnica/index"/>
            <outline text="VentureBeat" type="rss" xmlUrl="https://venturebeat.com/feed/"/>
            <outline text="Gizmodo" type="rss" xmlUrl="https://gizmodo.com/rss"/>
            <outline text="Digital Trends" type="rss" xmlUrl="https://www.digitaltrends.com/feed/"/>
            <outline text="Engadget" type="rss" xmlUrl="https://www.engadget.com/rss.xml"/>
            <outline text="How-To Geek" type="rss" xmlUrl="https://www.howtogeek.com/feed/"/>
            <outline text="Hacker News" type="rss" xmlUrl="https://news.ycombinator.com/rss"/>
            <outline text="Slashdot" type="rss" xmlUrl="http://rss.slashdot.org/Slashdot/slashdotMain"/>
        </outline>
        <outline text="Business" title="Business">
            <outline text="Wall Street Journal" type="rss" xmlUrl="https://feeds.a.dj.com/rss/RSSMarketsMain.xml"/>
            <outline text="Forbes" type="rss" xmlUrl="https://www.forbes.com/innovation/feed/"/>
            <outline text="Reuters Business" type="rss" xmlUrl="https://feeds.reuters.com/reuters/businessNews"/>
            <outline text="Financial Times" type="rss" xmlUrl="https://www.ft.com/rss/home"/>
            <outline text="MarketWatch" type="rss" xmlUrl="https://feeds.content.dowjones.io/public/rss/mw_topstories"/>
            <outline text="Bloomberg" type="rss" xmlUrl="https://feeds.bloomberg.com/markets/news.rss"/>
            <outline text="Harvard Business Review" type="rss" xmlUrl="https://hbr.org/rss/regular"/>
        </outline>
        <outline text="Science" title="Science">
            <outline text="Live Science" type="rss" xmlUrl="https://www.livescience.com/feeds/all"/>
            <outline text="Space.com" type="rss" xmlUrl="https://www.space.com/feeds/all"/>
            <outline text="Phys.org" type="rss" xmlUrl="https://phys.org/rss-feed/"/>
            <outline text="New Scientist" type="rss" xmlUrl="https://www.newscientist.com/feed/home/"/>
            <outline text="Scientific American" type="rss" xmlUrl="http://rss.sciam.com/ScientificAmerican-Global"/>
            <outline text="Nature" type="rss" xmlUrl="https://www.nature.com/nature/current-issue/rss"/>
            <outline text="ScienceDaily" type="rss" xmlUrl="https://www.sciencedaily.com/rss/all.xml"/>
        </outline>
        <outline text="Health" title="Health">
            <outline text="MedlinePlus What's New" type="rss" xmlUrl="https://medlineplus.gov/feeds/whatsnew.xml"/>
            <outline text="MedlinePlus New Topics" type="rss" xmlUrl="https://medlineplus.gov/groupfeeds/new.xml"/>
            <outline text="Harvard Health Publishing" type="rss" xmlUrl="https://www.health.harvard.edu/blog/rss"/>
            <outline text="Mayo Clinic News Network" type="rss" xmlUrl="https://newsnetwork.mayoclinic.org/feed/"/>
            <outline text="CDC Health News" type="rss" xmlUrl="https://tools.cdc.gov/podcasts/rss.asp"/>
            <outline text="WebMD Health" type="rss" xmlUrl="https://rssfeeds.webmd.com/rss/rss.aspx?RSSSource=RSS_PUBLIC"/>
            <outline text="Kaiser Health News" type="rss" xmlUrl="https://khn.org/feed/"/>
        </outline>
        <outline text="Politics" title="Politics">
            <outline text="Politico" type="rss" xmlUrl="https://www.politico.com/rss/politicopicks.xml"/>
            <outline text="The Hill" type="rss" xmlUrl="https://thehill.com/rss/syndicator/19109"/>
            <outline text="Washington Post Politics" type="rss" xmlUrl="http://feeds.washingtonpost.com/rss/politics"/>
            <outline text="NPR Politics" type="rss" xmlUrl="https://www.npr.org/rss/rss.php?id=1014"/>
            <outline text="CNN Politics" type="rss" xmlUrl="http://rss.cnn.com/rss/cnn_allpolitics.rss"/>
        </outline>
        <outline text="Sports" title="Sports">
            <outline text="ESPN" type="rss" xmlUrl="https://www.espn.com/espn/rss/news"/>
            <outline text="CBS Sports" type="rss" xmlUrl="https://www.cbssports.com/rss/headlines"/>
            <outline text="Yahoo Sports" type="rss" xmlUrl="https://sports.yahoo.com/rss/"/>
            <outline text="Sports Illustrated" type="rss" xmlUrl="https://www.si.com/rss/si_topstories.rss"/>
            <outline text="NBC Sports" type="rss" xmlUrl="https://scores.nbcsports.com/rss/headlines.asp"/>
        </outline>
        <outline text="Entertainment" title="Entertainment">
            <outline text="Variety" type="rss" xmlUrl="https://variety.com/feed/"/>
            <outline text="Rolling Stone" type="rss" xmlUrl="https://www.rollingstone.com/music/music-news/feed/"/>
            <outline text="Hollywood Reporter" type="rss" xmlUrl="https://www.hollywoodreporter.com/t/rss"/>
            <outline text="Entertainment Weekly" type="rss" xmlUrl="https://ew.com/feed/"/>
            <outline text="TMZ" type="rss" xmlUrl="https://www.tmz.com/rss.xml"/>
        </outline>
        <outline text="Lifestyle" title="Lifestyle">
            <outline text="Lifehacker" type="rss" xmlUrl="https://lifehacker.com/rss"/>
            <outline text="Apartment Therapy" type="rss" xmlUrl="https://www.apartmenttherapy.com/main.rss"/>
            <outline text="The Spruce" type="rss" xmlUrl="https://www.thespruce.com/rss"/>
            <outline text="Better Homes &amp; Gardens" type="rss" xmlUrl="https://www.bhg.com/rss/all/"/>
            <outline text="Real Simple" type="rss" xmlUrl="https://www.realsimple.com/rss/all/"/>
        </outline>
        <outline text="Education" title="Education">
            <outline text="Education Week" type="rss" xmlUrl="https://feeds.edweek.org/edweek/topstories"/>
            <outline text="Inside Higher Ed" type="rss" xmlUrl="https://www.insidehighered.com/rss/news"/>
            <outline text="Chronicle of Higher Education" type="rss" xmlUrl="https://www.chronicle.com/section/Home/5/rss"/>
            <outline text="The Hechinger Report" type="rss" xmlUrl="https://hechingerreport.org/feed/"/>
            <outline text="EdSurge" type="rss" xmlUrl="https://www.edsurge.com/rss"/>
        </outline>
        <outline text="Environment" title="Environment">
            <outline text="TreeHugger" type="rss" xmlUrl="https://www.treehugger.com/rss"/>
            <outline text="Grist" type="rss" xmlUrl="https://grist.org/feed/"/>
            <outline text="Inside Climate News" type="rss" xmlUrl="https://insideclimatenews.org/feed/"/>
            <outline text="Yale Environment 360" type="rss" xmlUrl="https://e360.yale.edu/rss"/>
            <outline text="Environmental Defense Fund" type="rss" xmlUrl="https://www.edf.org/rss.xml"/>
        </outline>
        <outline text="World News" title="World News">
            <outline text="BBC World" type="rss" xmlUrl="http://feeds.bbci.co.uk/news/world/rss.xml"/>
            <outline text="Al Jazeera" type="rss" xmlUrl="https://www.aljazeera.com/xml/rss/all.xml"/>
            <outline text="The Guardian World" type="rss" xmlUrl="https://www.theguardian.com/world/rss"/>
            <outline text="Reuters World News" type="rss" xmlUrl="https://feeds.reuters.com/reuters/worldnews"/>
            <outline text="NPR World" type="rss" xmlUrl="https://feeds.npr.org/1004/rss.xml"/>
            <outline text="Associated Press World" type="rss" xmlUrl="https://rsshub.app/apnews/topics/world-news"/>
            <outline text="Der Spiegel International" type="rss" xmlUrl="https://www.spiegel.de/international/index.rss"/>
        </outline>
        <outline text="Local News" title="Local News">
            <outline text="Google News - North Carolina" type="rss" xmlUrl="https://news.google.com/rss/search?q=North+Carolina+news&amp;hl=en&amp;gl=US&amp;ceid=US:en"/>
            <outline text="ABC11 Raleigh" type="rss" xmlUrl="https://abc11.com/feed/"/>
        </outline>
        <outline text="Food &amp; Cooking" title="Food &amp; Cooking">
            <outline text="Serious Eats" type="rss" xmlUrl="https://www.seriouseats.com/feeds/latest"/>
            <outline text="Allrecipes" type="rss" xmlUrl="https://www.allrecipes.com/feeds/all"/>
            <outline text="Bon Appétit" type="rss" xmlUrl="https://www.bonappetit.com/feed/recipes-rss-2.0/site"/>
        </outline>
        <outline text="Travel" title="Travel">
            <outline text="Condé Nast Traveler" type="rss" xmlUrl="https://www.cntraveler.com/rss"/>
            <outline text="Travel + Leisure" type="rss" xmlUrl="https://www.travelandleisure.com/feeds/all/rss"/>
            <outline text="Nomadic Matt" type="rss" xmlUrl="https://www.nomadicmatt.com/feed/"/>
        </outline>
        <outline text="Personal Finance" title="Personal Finance">
            <outline text="NerdWallet" type="rss" xmlUrl="https://www.nerdwallet.com/feed"/>
            <outline text="The Motley Fool" type="rss" xmlUrl="https://www.fool.com/feed/atom"/>
            <outline text="Money Under 30" type="rss" xmlUrl="https://www.moneyunder30.com/feed/"/>
        </outline>
        <outline text="Gaming" title="Gaming">
            <outline text="IGN" type="rss" xmlUrl="https://feeds.ign.com/ign/all"/>
            <outline text="GameSpot" type="rss" xmlUrl="https://www.gamespot.com/feeds/mashup/"/>
            <outline text="Kotaku" type="rss" xmlUrl="https://kotaku.com/rss"/>
        </outline>
        <outline text="Podcasts" title="Podcasts">
            <outline text="This American Life" type="rss" xmlUrl="http://feed.thisamericanlife.org/talpodcast"/>
            <outline text="Radiolab" type="rss" xmlUrl="http://feeds.wnyc.org/radiolab"/>
            <outline text="Freakonomics Radio" type="rss" xmlUrl="http://feeds.feedburner.com/freakonomicsradio"/>
        </outline>
    </outline>
</body>
</opml>`;

        // Default RSS feeds with categories
        const DEFAULT_RSS_FEEDS = [
            // General News
            { name: "The New York Times", url: "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml", category: "General News" },
            { name: "CNN Top Stories", url: "http://rss.cnn.com/rss/cnn_topstories.rss", category: "General News" },
            { name: "NPR News", url: "https://feeds.npr.org/1001/rss.xml", category: "General News" },
            { name: "CBS News", url: "https://www.cbsnews.com/latest/rss/main", category: "General News" },
            { name: "Associated Press", url: "https://feeds.apnews.com/rss/apf-topnews", category: "General News" },
            
            // Technology
            { name: "TechCrunch", url: "https://techcrunch.com/feed/", category: "Technology" },
            { name: "WIRED", url: "https://www.wired.com/feed/rss", category: "Technology" },
            { name: "The Verge", url: "https://www.theverge.com/rss/index.xml", category: "Technology" },
            { name: "CNET News", url: "https://www.cnet.com/rss/news/", category: "Technology" },
            { name: "Ars Technica", url: "http://feeds.arstechnica.com/arstechnica/index", category: "Technology" },
            { name: "VentureBeat", url: "https://venturebeat.com/feed/", category: "Technology" },
            { name: "Gizmodo", url: "https://gizmodo.com/rss", category: "Technology" },
            { name: "Digital Trends", url: "https://www.digitaltrends.com/feed/", category: "Technology" },
            { name: "Engadget", url: "https://www.engadget.com/rss.xml", category: "Technology" },
            { name: "How-To Geek", url: "https://www.howtogeek.com/feed/", category: "Technology" },
            { name: "Hacker News", url: "https://news.ycombinator.com/rss", category: "Technology" },
            { name: "Slashdot", url: "http://rss.slashdot.org/Slashdot/slashdotMain", category: "Technology" },
            
            // Business
            { name: "Wall Street Journal", url: "https://feeds.a.dj.com/rss/RSSMarketsMain.xml", category: "Business" },
            { name: "Forbes", url: "https://www.forbes.com/innovation/feed/", category: "Business" },
            { name: "Reuters Business", url: "https://feeds.reuters.com/reuters/businessNews", category: "Business" },
            { name: "Financial Times", url: "https://www.ft.com/rss/home", category: "Business" },
            { name: "MarketWatch", url: "https://feeds.content.dowjones.io/public/rss/mw_topstories", category: "Business" },
            { name: "Bloomberg", url: "https://feeds.bloomberg.com/markets/news.rss", category: "Business" },
            { name: "Harvard Business Review", url: "https://hbr.org/rss/regular", category: "Business" },
            
            // Science
            { name: "Live Science", url: "https://www.livescience.com/feeds/all", category: "Science" },
            { name: "Space.com", url: "https://www.space.com/feeds/all", category: "Science" },
            { name: "Phys.org", url: "https://phys.org/rss-feed/", category: "Science" },
            { name: "New Scientist", url: "https://www.newscientist.com/feed/home/", category: "Science" },
            { name: "Scientific American", url: "http://rss.sciam.com/ScientificAmerican-Global", category: "Science" },
            { name: "Nature", url: "https://www.nature.com/nature/current-issue/rss", category: "Science" },
            { name: "ScienceDaily", url: "https://www.sciencedaily.com/rss/all.xml", category: "Science" },
            
            // Health
            { name: "MedlinePlus What's New", url: "https://medlineplus.gov/feeds/whatsnew.xml", category: "Health" },
            { name: "Harvard Health Publishing", url: "https://www.health.harvard.edu/blog/rss", category: "Health" },
            { name: "Mayo Clinic News Network", url: "https://newsnetwork.mayoclinic.org/feed/", category: "Health" },
            { name: "WebMD Health", url: "https://rssfeeds.webmd.com/rss/rss.aspx?RSSSource=RSS_PUBLIC", category: "Health" },
            { name: "Kaiser Health News", url: "https://khn.org/feed/", category: "Health" },
            
            // Politics
            { name: "Politico", url: "https://www.politico.com/rss/politicopicks.xml", category: "Politics" },
            { name: "The Hill", url: "https://thehill.com/rss/syndicator/19109", category: "Politics" },
            { name: "Washington Post Politics", url: "http://feeds.washingtonpost.com/rss/politics", category: "Politics" },
            { name: "NPR Politics", url: "https://www.npr.org/rss/rss.php?id=1014", category: "Politics" },
            { name: "CNN Politics", url: "http://rss.cnn.com/rss/cnn_allpolitics.rss", category: "Politics" },
            
            // Sports
            { name: "ESPN", url: "https://www.espn.com/espn/rss/news", category: "Sports" },
            { name: "CBS Sports", url: "https://www.cbssports.com/rss/headlines", category: "Sports" },
            { name: "Yahoo Sports", url: "https://sports.yahoo.com/rss/", category: "Sports" },
            { name: "Sports Illustrated", url: "https://www.si.com/rss/si_topstories.rss", category: "Sports" },
            { name: "NBC Sports", url: "https://scores.nbcsports.com/rss/headlines.asp", category: "Sports" },
            
            // Entertainment
            { name: "Variety", url: "https://variety.com/feed/", category: "Entertainment" },
            { name: "Rolling Stone", url: "https://www.rollingstone.com/music/music-news/feed/", category: "Entertainment" },
            { name: "Hollywood Reporter", url: "https://www.hollywoodreporter.com/t/rss", category: "Entertainment" },
            { name: "Entertainment Weekly", url: "https://ew.com/feed/", category: "Entertainment" },
            { name: "TMZ", url: "https://www.tmz.com/rss.xml", category: "Entertainment" },
            
            // Lifestyle
            { name: "Lifehacker", url: "https://lifehacker.com/rss", category: "Lifestyle" },
            { name: "Apartment Therapy", url: "https://www.apartmenttherapy.com/main.rss", category: "Lifestyle" },
            { name: "The Spruce", url: "https://www.thespruce.com/rss", category: "Lifestyle" },
            { name: "Better Homes & Gardens", url: "https://www.bhg.com/rss/all/", category: "Lifestyle" },
            { name: "Real Simple", url: "https://www.realsimple.com/rss/all/", category: "Lifestyle" },
            
            // Education
            { name: "Education Week", url: "https://feeds.edweek.org/edweek/topstories", category: "Education" },
            { name: "Inside Higher Ed", url: "https://www.insidehighered.com/rss/news", category: "Education" },
            { name: "Chronicle of Higher Education", url: "https://www.chronicle.com/section/Home/5/rss", category: "Education" },
            { name: "The Hechinger Report", url: "https://hechingerreport.org/feed/", category: "Education" },
            { name: "EdSurge", url: "https://www.edsurge.com/rss", category: "Education" },
            
            // Environment
            { name: "TreeHugger", url: "https://www.treehugger.com/rss", category: "Environment" },
            { name: "Grist", url: "https://grist.org/feed/", category: "Environment" },
            { name: "Inside Climate News", url: "https://insideclimatenews.org/feed/", category: "Environment" },
            { name: "Yale Environment 360", url: "https://e360.yale.edu/rss", category: "Environment" },
            { name: "Environmental Defense Fund", url: "https://www.edf.org/rss.xml", category: "Environment" },
            
            // World News
            { name: "BBC World", url: "http://feeds.bbci.co.uk/news/world/rss.xml", category: "World News" },
            { name: "Al Jazeera", url: "https://www.aljazeera.com/xml/rss/all.xml", category: "World News" },
            { name: "The Guardian World", url: "https://www.theguardian.com/world/rss", category: "World News" },
            { name: "Reuters World News", url: "https://feeds.reuters.com/reuters/worldnews", category: "World News" },
            { name: "NPR World", url: "https://feeds.npr.org/1004/rss.xml", category: "World News" },
            
            // Local News
            { name: "Google News - North Carolina", url: "https://news.google.com/rss/search?q=North+Carolina+news&hl=en&gl=US&ceid=US:en", category: "Local News" },
            { name: "ABC11 Raleigh", url: "https://abc11.com/feed/", category: "Local News" },
            
            // Food & Cooking
            { name: "Serious Eats", url: "https://www.seriouseats.com/feeds/latest", category: "Food & Cooking" },
            { name: "Allrecipes", url: "https://www.allrecipes.com/feeds/all", category: "Food & Cooking" },
            { name: "Bon Appétit", url: "https://www.bonappetit.com/feed/recipes-rss-2.0/site", category: "Food & Cooking" },
            
            // Travel
            { name: "Condé Nast Traveler", url: "https://www.cntraveler.com/rss", category: "Travel" },
            { name: "Travel + Leisure", url: "https://www.travelandleisure.com/feeds/all/rss", category: "Travel" },
            { name: "Nomadic Matt", url: "https://www.nomadicmatt.com/feed/", category: "Travel" },
            
            // Personal Finance
            { name: "NerdWallet", url: "https://www.nerdwallet.com/feed", category: "Personal Finance" },
            { name: "The Motley Fool", url: "https://www.fool.com/feed/atom", category: "Personal Finance" },
            { name: "Money Under 30", url: "https://www.moneyunder30.com/feed/", category: "Personal Finance" },
            
            // Gaming
            { name: "IGN", url: "https://feeds.ign.com/ign/all", category: "Gaming" },
            { name: "GameSpot", url: "https://www.gamespot.com/feeds/mashup/", category: "Gaming" },
            { name: "Kotaku", url: "https://kotaku.com/rss", category: "Gaming" },
            
            // Podcasts
            { name: "This American Life", url: "http://feed.thisamericanlife.org/talpodcast", category: "Podcasts" },
            { name: "Radiolab", url: "http://feeds.wnyc.org/radiolab", category: "Podcasts" },
            { name: "Freakonomics Radio", url: "http://feeds.feedburner.com/freakonomicsradio", category: "Podcasts" }
        ];

        let currentRssFeeds = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadSettings();
            bindEvents();
            
            // Always show the news page with welcome section now
            // Users can configure API keys in settings if needed
            showNews();
        }

        function bindEvents() {
            // Navigation
            document.getElementById('navNews').addEventListener('click', showNews);
            document.getElementById('navSettings').addEventListener('click', showSettings);



            // Newsletter generation
            document.getElementById('generateNewsletter').addEventListener('click', generateNewsletter);
            document.getElementById('startOver').addEventListener('click', startOver);

            // Settings
            document.getElementById('saveAllSettings').addEventListener('click', saveAllSettings);
            document.getElementById('opmlFile').addEventListener('change', handleOpmlUpload);
            document.getElementById('clearOpml').addEventListener('click', clearOpml);
            document.getElementById('blockedTermInput').addEventListener('keypress', handleBlockedTermInput);
            document.getElementById('aiProvider').addEventListener('change', handleAiProviderChange);
            
            // View mode controls
            document.getElementById('viewModeRow').addEventListener('change', updateViewMode);
            document.getElementById('viewModeGrid').addEventListener('change', updateViewMode);

            // Modal
            document.getElementById('modalOkButton').addEventListener('click', closeModal);
            document.querySelector('.modal-close-button').addEventListener('click', closeModal);
        }

        function navigateToHome() {
            console.log('Navigating to home...');
            
            // Show news page and hide settings
            document.getElementById('newsPage').style.display = 'block';
            document.getElementById('settingsPage').style.display = 'none';
            
            // Show welcome section and hide articles
            const welcomeSection = document.getElementById('welcomeSection');
            const headerNewsletterBtn = document.getElementById('headerNewsletterBtn');
            
            if (welcomeSection) {
                welcomeSection.style.display = 'block';
                welcomeSection.style.visibility = 'visible';
                // Force a reflow to ensure content is visible
                welcomeSection.offsetHeight;
            } else {
                console.error('Welcome section not found');
            }
            
            if (headerNewsletterBtn) {
                headerNewsletterBtn.classList.add('hidden');
            }
            
            // Clear articles and reset state with safety checks
            const newsletterArea = document.getElementById('newsletterArea');
            if (newsletterArea) {
                newsletterArea.innerHTML = '';
                newsletterArea.style.display = 'none';
            }
            
            const statusMessageElement = document.getElementById('statusMessage');
            if (statusMessageElement) {
                statusMessageElement.textContent = '';
            }
            
            // Hide category filter container if it exists
            const categoryFilterContainer = document.getElementById('categoryFilterContainer');
            if (categoryFilterContainer) {
                categoryFilterContainer.remove();
            }
            
            // Hide load more button if it exists
            const loadMoreBtn = document.getElementById('loadMoreArticles');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = 'none';
            }
            
            // Remove source filter container by finding elements with "Filter by source" text
            try {
                const sourceFilterElements = document.querySelectorAll('*');
                sourceFilterElements.forEach(element => {
                    if (element && element.textContent && element.textContent.includes('Filter by source:')) {
                        const container = element.closest('div');
                        if (container && container.parentNode) {
                            container.remove();
                        }
                    }
                });
                
                // Remove any remaining source filter buttons
                const sourceFilters = document.querySelectorAll('.source-filter-btn');
                sourceFilters.forEach(btn => {
                    if (btn && btn.parentNode) {
                        const container = btn.closest('div');
                        if (container && container.parentNode) {
                            container.remove();
                        }
                    }
                });
            } catch (error) {
                console.log('Error cleaning up source filters:', error);
            }
            
            // Hide article index
            const articleIndex = document.getElementById('articleIndex');
            if (articleIndex) {
                articleIndex.style.display = 'none';
            }
            
            // Reset category selections
            selectedCategories = [];
            selectedFilterCategories = [];
            
            // Hide header controls
            const headerControls = document.getElementById('headerControls');
            if (headerControls) {
                headerControls.style.display = 'none';
            }
            
            // Reset category buttons
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('generateFromSelection').style.display = 'none';
            
            // Clear global state
            window.currentDisplayedArticles = [];
            
            // Force welcome section visibility
            setTimeout(() => {
                const welcomeSectionCheck = document.getElementById('welcomeSection');
                if (welcomeSectionCheck) {
                    welcomeSectionCheck.style.display = 'block';
                    welcomeSectionCheck.style.visibility = 'visible';
                    welcomeSectionCheck.style.opacity = '1';
                }
            }, 50);
        }

        function showNews() {
            // Alias for backward compatibility
            navigateToHome();
        }

        function showSettings() {
            document.getElementById('newsPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'block';
        }

        function loadSettings() {
            // Load RSS feeds
            const storedOpml = localStorage.getItem('opmlData');
            if (storedOpml) {
                parseOpml(storedOpml);
                document.getElementById('opmlFileInfo').textContent = 'Custom OPML loaded';
            } else {
                // Use default feeds array directly
                currentRssFeeds = [...DEFAULT_RSS_FEEDS];
                document.getElementById('opmlFileInfo').textContent = 'Using default feeds (90+ sources)';
                console.log(`Loaded ${currentRssFeeds.length} RSS feeds`);
                populateCategoryDropdown();
            }

            // Load AI provider and API keys
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            document.getElementById('aiProvider').value = aiProvider;
            
            // Load API keys
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            if (geminiApiKey) {
                document.getElementById('geminiApiKey').value = geminiApiKey;
            }
            
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            if (openaiApiKey) {
                document.getElementById('openaiApiKey').value = openaiApiKey;
            }
            
            // Show/hide appropriate config section
            handleAiProviderChange();



            const showSourceInfo = localStorage.getItem('showSourceInfo');
            document.getElementById('showSourceInfo').checked = showSourceInfo !== 'false';

            const showCategories = localStorage.getItem('showCategories');
            document.getElementById('showCategories').checked = showCategories !== 'false';

            // Load AI rewrite settings
            const aiRewrite = localStorage.getItem('aiRewrite');
            document.getElementById('aiRewrite').checked = aiRewrite === 'true';
            
            const aiStyle = localStorage.getItem('aiStyle') || 'professional';
            document.getElementById('aiStyle').value = aiStyle;
            
            // Content Enhancement settings removed - only used in AI Rewrite mode

            // Load custom AI prompt with updated default value
            const defaultPrompt = `{article.title}

Write ONE paragraph summary.`;
            
            // Force update for existing users who might have old prompt
            let customPrompt = localStorage.getItem('customPrompt');
            if (!customPrompt || customPrompt.includes('Write ONE sentence summary. Maximum 10 words.')) {
                customPrompt = defaultPrompt;
                localStorage.setItem('customPrompt', defaultPrompt);
            }
            document.getElementById('customPrompt').value = customPrompt;

            // Load view mode preference - default to row view
            const viewMode = localStorage.getItem('viewMode') || 'row';
            if (viewMode === 'row') {
                document.getElementById('viewModeRow').checked = true;
            } else {
                document.getElementById('viewModeGrid').checked = true;
            }
            updateViewMode();

            // Load blocked terms
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            displayBlockedTerms(blockedTerms);

            // Load zip code for local news
            const zipCode = localStorage.getItem('zipCode') || '';
            document.getElementById('zipCode').value = zipCode;
        }

        function saveAllSettings() {
            // Save AI provider and API keys
            localStorage.setItem('aiProvider', document.getElementById('aiProvider').value);
            
            const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            if (geminiApiKey) {
                localStorage.setItem('geminiApiKey', geminiApiKey);
            }
            
            const openaiApiKey = document.getElementById('openaiApiKey').value.trim();
            if (openaiApiKey) {
                localStorage.setItem('openaiApiKey', openaiApiKey);
            }

            // Save other settings with null checks
            const showSourceInfo = document.getElementById('showSourceInfo');
            if (showSourceInfo) {
                localStorage.setItem('showSourceInfo', showSourceInfo.checked);
            }
            
            const showCategories = document.getElementById('showCategories');
            if (showCategories) {
                localStorage.setItem('showCategories', showCategories.checked);
            }
            
            // Save AI rewrite settings with null checks
            const aiRewrite = document.getElementById('aiRewrite');
            if (aiRewrite) {
                localStorage.setItem('aiRewrite', aiRewrite.checked);
            }
            
            const aiStyle = document.getElementById('aiStyle');
            if (aiStyle) {
                localStorage.setItem('aiStyle', aiStyle.value);
            }
            
            const addContext = document.getElementById('addContext');
            if (addContext) {
                localStorage.setItem('addContext', addContext.checked);
            }
            
            const includeImpact = document.getElementById('includeImpact');
            if (includeImpact) {
                localStorage.setItem('includeImpact', includeImpact.checked);
            }
            
            const addQuestions = document.getElementById('addQuestions');
            if (addQuestions) {
                localStorage.setItem('addQuestions', addQuestions.checked);
            }
            
            const customPrompt = document.getElementById('customPrompt');
            if (customPrompt) {
                localStorage.setItem('customPrompt', customPrompt.value.trim());
            }

            // Save zip code for local news
            const zipCode = document.getElementById('zipCode').value.trim();
            localStorage.setItem('zipCode', zipCode);

            // Show toast notification and navigate to home
            showToast('Settings saved successfully!', 'success');
            setTimeout(() => {
                navigateToHome();
            }, 500);
        }

        function handleAiProviderChange() {
            const provider = document.getElementById('aiProvider').value;
            const geminiConfig = document.getElementById('geminiConfig');
            const openaiConfig = document.getElementById('openaiConfig');
            
            if (provider === 'gemini') {
                geminiConfig.style.display = 'block';
                openaiConfig.style.display = 'none';
            } else {
                geminiConfig.style.display = 'none';
                openaiConfig.style.display = 'block';
            }
        }

        function closeModal() {
            document.getElementById('saveConfirmModal').style.display = 'none';
            showNews();
        }

        function handleOpmlUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const opmlContent = e.target.result;
                    parseOpml(opmlContent);
                    localStorage.setItem('opmlData', opmlContent);
                    document.getElementById('opmlFileInfo').textContent = `Custom OPML loaded: ${file.name}`;
                    
                    // Repopulate categories from the new OPML
                    populateCategoryDropdown();
                    
                    showToast('OPML file loaded successfully', 'success');
                };
                reader.readAsText(file);
            }
        }

        function clearOpml() {
            localStorage.removeItem('opmlData');
            
            // Restore default feeds array
            currentRssFeeds = [...DEFAULT_RSS_FEEDS];
            console.log(`Loaded ${currentRssFeeds.length} RSS feeds`);
            
            document.getElementById('opmlFile').value = '';
            document.getElementById('opmlFileInfo').textContent = 'Using default feeds (90+ sources)';
            
            // Repopulate categories from default feeds
            populateCategoryDropdown();
            
            showToast('Cleared custom OPML, using default feeds', 'info');
        }

        function startOver() {
            // Navigate to home page cleanly
            window.location.href = window.location.origin + window.location.pathname;
        }

        function parseOpml(opmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(opmlContent, 'text/xml');
                const outlines = xmlDoc.querySelectorAll('outline[type="rss"]');
                
                currentRssFeeds = Array.from(outlines).map(outline => ({
                    name: outline.getAttribute('text'),
                    url: outline.getAttribute('xmlUrl'),
                    category: outline.parentElement.getAttribute('text') || 'general'
                }));
                
                console.log(`Loaded ${currentRssFeeds.length} RSS feeds`);
                
                // Populate category dropdown with categories from OPML
                populateCategoryDropdown();
            } catch (error) {
                console.error('Error parsing OPML:', error);
                showToast('Error loading OPML file', 'error');
            }
        }

        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('categorySelect');
            const categoryButtons = document.getElementById('categoryButtons');
            
            // Get unique categories from RSS feeds
            const categories = [...new Set(currentRssFeeds.map(feed => feed.category).filter(Boolean))];
            
            // Clear existing options except "All Categories"
            categorySelect.innerHTML = '<option value="all">All Categories</option>';
            
            // Add categories from OPML to dropdown
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category.toLowerCase();
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Update category buttons
            categoryButtons.innerHTML = '<button onclick="quickCategory(\'all\')" class="category-button special px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-blue-700 transition-all shadow-sm">All Categories</button>';
            
            // Add category buttons from OPML with different colors
            const colors = [
                'blue', 'green', 'purple', 'indigo', 'red', 'gray', 'orange', 'pink', 
                'yellow', 'teal', 'emerald', 'amber', 'cyan', 'violet', 'rose'
            ];
            
            categories.sort().forEach((category, index) => {
                const color = colors[index % colors.length];
                const button = document.createElement('button');
                button.onclick = () => toggleCategory(category.toLowerCase());
                button.className = `category-button px-4 py-3 bg-${color}-50 text-${color}-700 rounded-lg text-sm font-medium hover:bg-${color}-100 transition-colors border border-${color}-200`;
                button.textContent = category;
                button.setAttribute('data-category', category.toLowerCase());
                categoryButtons.appendChild(button);
            });
            
            console.log('Categories populated:', categories);
        }

        function handleBlockedTermInput(event) {
            if (event.key === 'Enter') {
                const term = event.target.value.trim().toLowerCase();
                if (term) {
                    addBlockedTerm(term);
                    event.target.value = '';
                }
            }
        }

        function addBlockedTerm(term) {
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            if (!blockedTerms.includes(term)) {
                blockedTerms.push(term);
                localStorage.setItem('blockedTerms', JSON.stringify(blockedTerms));
                displayBlockedTerms(blockedTerms);
                showToast(`Blocked term added: ${term}`, 'success');
            }
        }

        function removeBlockedTerm(term) {
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            const filtered = blockedTerms.filter(t => t !== term);
            localStorage.setItem('blockedTerms', JSON.stringify(filtered));
            displayBlockedTerms(filtered);
            showToast(`Blocked term removed: ${term}`, 'info');
        }

        function displayBlockedTerms(terms) {
            const container = document.getElementById('blockedTermsList');
            container.innerHTML = terms.map(term => 
                `<span class="blocked-term-pill">
                    ${term}
                    <button onclick="removeBlockedTerm('${term}')">&times;</button>
                </span>`
            ).join('');
        }

        function updateViewMode() {
            const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
            localStorage.setItem('viewMode', viewMode);
            
            const newsletterArea = document.getElementById('newsletterArea');
            if (viewMode === 'grid') {
                newsletterArea.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            } else {
                newsletterArea.className = 'grid grid-cols-1 gap-6';
            }
        }

        async function generateLocalNewsFeeds() {
            const zipCode = localStorage.getItem('zipCode');
            if (!zipCode) {
                console.log('No zip code configured for local news');
                return [];
            }

            try {
                // Convert zip code to city/state for better search results
                const locationInfo = await getLocationFromZipCode(zipCode);
                const searchTerms = locationInfo ? [locationInfo.city, locationInfo.state, zipCode] : [zipCode];
                
                const localFeeds = [];
                
                // Generate Google News RSS feeds for local area
                for (const term of searchTerms) {
                    if (term) {
                        localFeeds.push({
                            name: `Google News - ${term}`,
                            url: `https://news.google.com/rss/search?q=${encodeURIComponent(term + ' news')}`,
                            category: 'local news'
                        });
                    }
                }

                // Add additional local news sources based on major cities
                const citySpecificFeeds = await getCitySpecificFeeds(locationInfo);
                localFeeds.push(...citySpecificFeeds);

                console.log(`Generated ${localFeeds.length} local news feeds for zip code ${zipCode}`);
                return localFeeds;
                
            } catch (error) {
                console.error('Error generating local news feeds:', error);
                return [{
                    name: `Google News - ${zipCode}`,
                    url: `https://news.google.com/rss/search?q=${encodeURIComponent(zipCode + ' local news')}`,
                    category: 'local news'
                }];
            }
        }

        async function getLocationFromZipCode(zipCode) {
            try {
                // Use a free zip code API to get city/state information
                const response = await fetch(`https://api.zippopotam.us/us/${zipCode}`);
                if (response.ok) {
                    const data = await response.json();
                    return {
                        city: data.places[0]['place name'],
                        state: data.places[0]['state abbreviation'],
                        fullState: data.places[0].state
                    };
                }
            } catch (error) {
                console.log('Could not resolve zip code to location:', error);
            }
            return null;
        }

        async function getCitySpecificFeeds(locationInfo) {
            if (!locationInfo) return [];
            
            const cityFeeds = [];
            const city = locationInfo.city.toLowerCase();
            const state = locationInfo.state.toLowerCase();
            
            // Major city newspaper feeds
            const cityNewspapers = {
                'new york': ['https://rss.cnn.com/rss/edition.rss', 'https://feeds.npr.org/1001/rss.xml'],
                'los angeles': ['https://feeds.latimes.com/latimes/news'],
                'chicago': ['https://feeds.chicagotribune.com/chicagotribune/news'],
                'houston': ['https://feeds.chron.com/chronicle/news'],
                'phoenix': ['https://feeds.azcentral.com/phoenix/news'],
                'philadelphia': ['https://feeds.inquirer.com/news'],
                'san antonio': ['https://feeds.mysanantonio.com/news'],
                'san diego': ['https://feeds.sandiegouniontribune.com/news'],
                'dallas': ['https://feeds.dallasnews.com/news'],
                'san jose': ['https://feeds.mercurynews.com/news']
            };

            if (cityNewspapers[city]) {
                cityNewspapers[city].forEach((url, index) => {
                    cityFeeds.push({
                        name: `${locationInfo.city} Local News ${index + 1}`,
                        url: url,
                        category: 'local news'
                    });
                });
            }

            // State-wide news sources
            cityFeeds.push({
                name: `Google News - ${locationInfo.fullState}`,
                url: `https://news.google.com/rss/search?q=${encodeURIComponent(locationInfo.fullState + ' state news')}`,
                category: 'local news'
            });

            return cityFeeds;
        }

        async function generateNewsletter() {
            const category = document.getElementById('categorySelect').value;
            const maxArticles = 20; // Fixed to 20 articles
            const digestLength = 'brief'; // Always brief summaries

            // Clear previous content when generating new newsletter
            clearPreviousContent();

            // Check if API key is configured before starting
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            const apiKey = aiProvider === 'gemini' ? geminiApiKey : openaiApiKey;
            
            if (!apiKey) {
                showToast(`Please configure your ${aiProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API key in settings`, 'error');
                return;
            }

            // Show loading state with witty message
            const loadingMessages = [
                "Convincing journalists to share their best stories...",
                "Teaching AI to read between the headlines...",
                "Herding cats... I mean, organizing news articles...",
                "Downloading the latest gossip from news servers...",
                "Asking the internet what happened today...",
                "Translating news-speak into human language...",
                "Sorting through the digital noise for real news...",
                "Bribing RSS feeds with virtual cookies...",
                "Connecting to the news matrix... red pill or blue pill?",
                "Waking up sleeping news algorithms...",
                "Negotiating with stubborn news servers...",
                "Teaching robots to appreciate good journalism...",
                "Filtering out the fake news from the real deals...",
                "Summoning the news spirits from the cloud...",
                "Converting coffee into breaking news alerts...",
                "Asking AI what humans actually want to read...",
                "Synchronizing with the global news consciousness...",
                "Untangling the web of worldwide information...",
                "Politely requesting updates from news headquarters...",
                "Transforming data streams into digestible insights...",
                "Curating today's digital newspaper just for you..."
            ];
            
            const randomMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            document.getElementById('statusMessage').textContent = randomMessage;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('newsletterArea').innerHTML = '';

            try {
                // Filter feeds by category
                let feedsToUse = currentRssFeeds;
                if (category !== 'all') {
                    feedsToUse = currentRssFeeds.filter(feed => {
                        if (!feed.category) return false;
                        const feedCat = feed.category.toLowerCase().trim();
                        const selectedCat = category.toLowerCase().trim();
                        
                        // Exact match for category filtering
                        return feedCat === selectedCat;
                    });
                    
                    // Add local news feeds if local news category is selected
                    if (category.toLowerCase() === 'local news') {
                        const localFeeds = await generateLocalNewsFeeds();
                        feedsToUse = [...feedsToUse, ...localFeeds];
                    }
                    
                    console.log(`Selected category: ${category}`);
                    console.log(`Filtered ${feedsToUse.length} feeds for category: ${category}`);
                    console.log('Feeds to use:', feedsToUse.map(f => f.name));
                    
                    if (feedsToUse.length === 0) {
                        const availableCategories = [...new Set(currentRssFeeds.map(f => f.category).filter(Boolean))];
                        document.getElementById('statusMessage').textContent = `No feeds found for category: ${category}`;
                        document.getElementById('loader').classList.add('hidden');
                        showToast(`No feeds found for category: ${category}`, 'error');
                        return;
                    }
                }

                // Fetch articles from RSS feeds (fetch more to account for filtering)
                const articles = await fetchArticlesFromFeeds(feedsToUse, maxArticles * 4);
                
                if (articles.length === 0) {
                    throw new Error('No articles found for the selected criteria');
                }

                // Apply blocked terms filter
                const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
                const cleanArticles = filterBlockedTerms(articles, blockedTerms);

                // Remove duplicate articles and keep the best version
                const uniqueArticles = removeDuplicateArticles(cleanArticles);

                // Sort articles with breaking news first
                const sortedArticles = sortArticlesWithBreakingFirst(uniqueArticles);

                // Limit to max articles
                const finalArticles = sortedArticles.slice(0, maxArticles);

                // Generate AI summaries
                const processedArticles = await generateAISummaries(finalArticles, digestLength, category);

                // Display articles
                displayArticles(processedArticles);

                document.getElementById('statusMessage').textContent = `Generated ${processedArticles.length} article summaries`;
                
            } catch (error) {
                console.error('Error generating newsletter:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('statusMessage').textContent = `Error generating newsletter: ${error.message}`;
                const errorMessage = error.message || 'An unexpected error occurred';
                showToast(`Error: ${errorMessage}`, 'error');
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function filterArticlesByDate(articles, dateRange) {
            if (dateRange === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return articles.filter(article => {
                    const articleDate = new Date(article.pubDate);
                    return articleDate >= today;
                });
            }
            return articles; // 'anytime' returns all articles
        }

        function sortArticlesWithBreakingFirst(articles) {
            return articles.sort((a, b) => {
                // Check if articles contain breaking news keywords
                const aIsBreaking = isBreakingNews(a);
                const bIsBreaking = isBreakingNews(b);
                
                // ALWAYS prioritize breaking news first regardless of other sorting
                if (aIsBreaking && !bIsBreaking) return -1;
                if (!aIsBreaking && bIsBreaking) return 1;
                
                // If both or neither are breaking, sort by date (newest first)
                return new Date(b.pubDate) - new Date(a.pubDate);
            });
        }

        function isBreakingNews(article) {
            // Only apply breaking news to general news and world news categories
            const allowedCategories = ['general news', 'world news', 'general'];
            const isAllowedCategory = allowedCategories.some(cat => 
                article.category.toLowerCase().includes(cat.toLowerCase())
            );
            
            if (!isAllowedCategory) {
                return false;
            }
            
            const breakingKeywords = [
                'breaking', 'urgent', 'alert', 'developing', 'live', 'just in',
                'emergency', 'crisis', 'explosion', 'attack', 'disaster', 
                'confirmed dead', 'killed', 'warning', 'critical situation'
            ];
            
            const text = (article.title + ' ' + (article.description || '')).toLowerCase();
            const hasBreakingKeyword = breakingKeywords.some(keyword => text.includes(keyword));
            
            // Only mark as breaking if it has explicit breaking keywords AND is recent (last 4 hours)
            const articleDate = new Date(article.pubDate);
            const fourHoursAgo = new Date(Date.now() - 4 * 60 * 60 * 1000);
            const isRecent = articleDate > fourHoursAgo;
            
            return hasBreakingKeyword && isRecent;
        }

        function filterBlockedTerms(articles, blockedTerms) {
            if (blockedTerms.length === 0) return articles;
            
            return articles.filter(article => {
                const text = (article.title + ' ' + article.description).toLowerCase();
                return !blockedTerms.some(term => {
                    const termLower = term.toLowerCase();
                    return text.includes(termLower);
                });
            });
        }

        function removeDuplicateArticles(articles) {
            const uniqueArticles = [];
            const seenTitles = new Set();
            
            // Sort by source quality and recency to pick the best version
            const sortedArticles = articles.sort((a, b) => {
                // Prefer sources with longer content
                const aLength = (a.fullContent || a.description || '').length;
                const bLength = (b.fullContent || b.description || '').length;
                if (aLength !== bLength) return bLength - aLength;
                
                // Then prefer more recent articles
                return new Date(b.pubDate) - new Date(a.pubDate);
            });
            
            for (const article of sortedArticles) {
                const titleWords = article.title.toLowerCase().split(' ').filter(word => word.length > 3);
                const titleKey = titleWords.slice(0, 5).join(' '); // Use first 5 significant words
                
                // Check if we've seen a similar title
                let isDuplicate = false;
                for (const seenTitle of seenTitles) {
                    const similarity = calculateSimilarity(titleKey, seenTitle);
                    if (similarity > 0.7) { // 70% similarity threshold
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    seenTitles.add(titleKey);
                    uniqueArticles.push(article);
                }
            }
            
            return uniqueArticles;
        }

        function calculateSimilarity(str1, str2) {
            const words1 = str1.split(' ');
            const words2 = str2.split(' ');
            const commonWords = words1.filter(word => words2.includes(word));
            return commonWords.length / Math.max(words1.length, words2.length);
        }

        function cleanHtmlContent(text) {
            if (!text) return '';
            // Remove HTML tags and decode entities
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || '';
        }

        async function fetchArticlesFromFeeds(feeds, maxArticles) {
            const articles = [];
            const corsProxies = [
                'https://api.rss2json.com/v1/api.json?rss_url=',
                'https://api.allorigins.win/get?url=',
                'https://corsproxy.io/?'
            ];
            let proxyIndex = 0;
            
            // Process feeds in parallel with larger batch size for more articles
            const feedPromises = feeds.slice(0, 25).map(async (feed) => {
                try {
                    let response, data, xmlText;
                    let lastError;
                    
                    // Try multiple CORS proxies
                    for (let i = 0; i < corsProxies.length; i++) {
                        try {
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 4000);
                            
                            const corsProxy = corsProxies[i];
                            const fetchUrl = corsProxy + encodeURIComponent(feed.url);
                            
                            response = await fetch(fetchUrl, {
                                signal: controller.signal,
                                headers: {
                                    'Accept': 'application/json, text/plain, */*'
                                }
                            });
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            
                            if (corsProxy.includes('rss2json')) {
                                // Handle rss2json API response
                                data = await response.json();
                                if (data.status === 'ok' && data.items) {
                                    const feedArticles = [];
                                    for (const item of data.items.slice(0, 3)) {
                                        feedArticles.push({
                                            title: item.title || 'No Title',
                                            description: item.description || '',
                                            fullContent: item.content || item.description || '',
                                            link: item.link || '',
                                            pubDate: item.pubDate || new Date().toISOString(),
                                            source: feed.name,
                                            category: feed.category,
                                            imageUrl: item.thumbnail || ''
                                        });
                                    }
                                    return feedArticles;
                                }
                                throw new Error('RSS2JSON failed');
                            } else if (corsProxy.includes('allorigins')) {
                                data = await response.json();
                                xmlText = data.contents;
                            } else {
                                xmlText = await response.text();
                            }
                            
                            if (xmlText && xmlText.trim()) {
                                break; // Success
                            }
                        } catch (error) {
                            lastError = error;
                            console.warn(`Failed proxy ${i + 1} for ${feed.name}:`, error.message);
                            continue;
                        }
                    }
                    
                    if (!xmlText || !xmlText.trim()) {
                        throw lastError || new Error('No content received');
                    }
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    
                    if (xmlDoc.querySelector('parsererror')) return [];
                    
                    const items = xmlDoc.querySelectorAll('item');
                    const feedArticles = [];
                    
                    for (const item of Array.from(items).slice(0, 3)) {
                        const rawTitle = item.querySelector('title')?.textContent || 'No Title';
                        const rawDescription = item.querySelector('description')?.textContent || '';
                        const rawContent = item.querySelector('content\\:encoded')?.textContent || rawDescription;
                        
                        // Improved image extraction with fallback filtering
                        let imageUrl = '';
                        
                        const enclosure = item.querySelector('enclosure[type^="image"]');
                        if (enclosure) {
                            imageUrl = enclosure.getAttribute('url');
                        }
                        
                        if (!imageUrl) {
                            const mediaContent = item.querySelector('media\\:content[medium="image"], media\\:content[type^="image"]');
                            if (mediaContent) {
                                imageUrl = mediaContent.getAttribute('url');
                            }
                        }
                        
                        if (!imageUrl) {
                            const imgMatch = (rawContent || rawDescription).match(/<img[^>]+src=["']([^"']+)["']/i);
                            if (imgMatch) {
                                const imgSrc = imgMatch[1];
                                // Filter out social media icons and generic images
                                if (!imgSrc.includes('twitter.com') && !imgSrc.includes('facebook.com') && 
                                    !imgSrc.includes('icon') && !imgSrc.includes('logo') && 
                                    !imgSrc.includes('avatar') && imgSrc.length > 30) {
                                    imageUrl = imgSrc;
                                }
                            }
                        }
                        
                        const cleanContent = cleanHtmlContent(rawContent || rawDescription);
                        
                        if (cleanContent.length > 50) {
                            const article = {
                                title: cleanHtmlContent(rawTitle),
                                description: cleanContent.substring(0, 500),
                                fullContent: cleanContent,
                                link: item.querySelector('link')?.textContent || '',
                                pubDate: item.querySelector('pubDate')?.textContent || new Date().toISOString(),
                                source: feed.name,
                                category: feed.category,
                                imageUrl: imageUrl,
                                isBreaking: false
                            };
                            
                            article.isBreaking = isBreakingNews(article);
                            feedArticles.push(article);
                        }
                    }
                    
                    return feedArticles;
                } catch (error) {
                    console.warn(`Failed to fetch from ${feed.name}:`, error.message);
                    return [];
                }
            });
            
            // Wait for all with timeout
            const feedResults = await Promise.allSettled(feedPromises);
            
            feedResults.forEach(result => {
                if (result.status === 'fulfilled') {
                    articles.push(...result.value);
                }
            });
            
            console.log(`Fetched ${articles.length} articles from feeds`);
            return articles;
        }

        async function generateAISummaries(articles, digestLength, category) {
            const processedArticles = [];
            const batchSize = 5; // Increased batch size for speed
            
            // Get AI provider and settings
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            let apiKey;
            
            if (aiProvider === 'gemini') {
                // Get Gemini API key from localStorage or environment
                apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    // Try to get from environment if available
                    try {
                        apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : null;
                    } catch (e) {
                        apiKey = null;
                    }
                }
            } else {
                // Get OpenAI API key from localStorage or environment
                apiKey = localStorage.getItem('openaiApiKey');
                if (!apiKey) {
                    try {
                        apiKey = typeof OPENAI_API_KEY !== 'undefined' ? OPENAI_API_KEY : null;
                    } catch (e) {
                        apiKey = null;
                    }
                }
            }
            
            if (!apiKey) {
                throw new Error(`Please configure your ${aiProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API key in settings`);
            }
            
            // Get AI rewrite settings
            const aiRewrite = localStorage.getItem('aiRewrite') === 'true';
            const aiStyle = localStorage.getItem('aiStyle') || 'professional';
            const addContext = localStorage.getItem('addContext') !== 'false';
            const includeImpact = localStorage.getItem('includeImpact') !== 'false';
            const addQuestions = localStorage.getItem('addQuestions') === 'true';
            
            for (let i = 0; i < articles.length; i += batchSize) {
                const batch = articles.slice(i, i + batchSize);
                const batchPromises = batch.map(async (article) => {
                    try {
                        // Validate article object
                        if (!article || typeof article !== 'object') {
                            throw new Error('Invalid article object');
                        }
                        
                        let prompt = '';
                        let maxTokens = 200;
                        let aiContent = '';
                        
                        if (aiRewrite) {
                            // AI Rewrite mode - transform the article completely
                            const styleInstructions = {
                                'professional': 'Write in a professional, neutral tone suitable for business readers.',
                                'conversational': 'Write in a conversational, engaging tone that is easy to read.',
                                'analytical': 'Write in an analytical, in-depth style with detailed explanations.',
                                'simple': 'Write in simple, clear language that anyone can understand.'
                            };
                            
                            const lengthInstructions = {
                                'brief': '2-3 paragraphs',
                                'medium': '3-4 paragraphs', 
                                'detailed': '4-5 paragraphs'
                            };
                            
                            prompt = `Rewrite this news story as a ${lengthInstructions[digestLength]} article. ${styleInstructions[aiStyle]}

Original headline: ${article.title || 'No title'}
Original content: ${(article.description || '').substring(0, 600)}

Instructions:
- Create an engaging, well-structured article
- Keep the core facts accurate but improve readability
- Use clear, compelling language
${addContext ? '- Add relevant background context where helpful' : ''}
${includeImpact ? '- Include analysis of potential impacts or implications' : ''}
${addQuestions ? '- End with 1-2 thought-provoking questions for readers' : ''}

Write the complete rewritten article:`;
                            
                            maxTokens = digestLength === 'brief' ? 300 : digestLength === 'medium' ? 500 : 700;
                        } else {
                            // Standard summary mode - keep very concise
                            // Check for custom prompt first
                            const customPrompt = localStorage.getItem('customPrompt');
                            if (customPrompt && customPrompt.trim()) {
                                prompt = customPrompt
                                    .replace('{article.title}', article.title || 'No title')
                                    .replace('{article.description}', article.description || '');
                                maxTokens = 150; // Adequate tokens for paragraph summaries
                            } else if (digestLength === 'brief') {
                                prompt = `${article.title || 'No title'}

Write ONE sentence summary. Maximum 10 words.`;
                                maxTokens = 15;
                            } else if (digestLength === 'medium') {
                                prompt = `${article.title || 'No title'}

Write exactly 2 short sentences.`;
                                maxTokens = 50;
                            } else {
                                prompt = `${article.title || 'No title'}

Write exactly 3 sentences.`;
                                maxTokens = 80;
                            }
                        }

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);

                        if (aiProvider === 'gemini') {
                            
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{
                                            text: prompt
                                        }]
                                    }],
                                    generationConfig: {
                                        maxOutputTokens: maxTokens,
                                        temperature: digestLength === 'brief' && !aiRewrite ? 0.1 : (aiRewrite ? 0.7 : 0.3)
                                    }
                                }),
                                signal: controller.signal
                            });

                            if (!response.ok) {
                                throw new Error(`Gemini API Error: ${response.status}`);
                            }

                            const data = await response.json();
                            aiContent = data.candidates?.[0]?.content?.parts?.[0]?.text || article.description;
                        } else {
                            // OpenAI API call
                            const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'gpt-4o', // the newest OpenAI model is "gpt-4o" which was released May 13, 2024. do not change this unless explicitly requested by the user
                                    messages: [{
                                        role: 'user',
                                        content: prompt
                                    }],
                                    max_tokens: maxTokens,
                                    temperature: digestLength === 'brief' && !aiRewrite ? 0.1 : (aiRewrite ? 0.7 : 0.3)
                                }),
                                signal: controller.signal
                            });

                            if (!openaiResponse.ok) {
                                const errorData = await openaiResponse.text();
                                console.error('OpenAI API Error:', openaiResponse.status, errorData);
                                throw new Error(`OpenAI API Error: ${openaiResponse.status} - ${errorData}`);
                            }

                            const openaiData = await openaiResponse.json();
                            aiContent = openaiData.choices?.[0]?.message?.content || article.description;
                        }

                        clearTimeout(timeoutId);

                        return {
                            ...article,
                            aiSummary: cleanHtmlContent(aiContent),
                            isRewritten: aiRewrite
                        };

                    } catch (error) {
                        console.warn(`AI processing failed for article: ${article.title}`, error.message);
                        console.error('Full error details:', error);
                        return {
                            ...article,
                            aiSummary: article.description || 'Summary unavailable',
                            isRewritten: false
                        };
                    }
                });

                // Process batch with reduced delay
                const batchResults = await Promise.allSettled(batchPromises);
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled') {
                        processedArticles.push(result.value);
                    }
                });

                // Minimal delay between batches
                if (i + batchSize < articles.length) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            return processedArticles;
        }

        function displayArticles(articles) {
            // Store articles globally for category filtering
            window.currentDisplayedArticles = articles;
            
            // Hide welcome section when articles are displayed
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Articles are now displayed without extra header
            
            // Update floating buttons visibility
            toggleFloatingButtons();
            
            // Create article index
            createArticleIndex(articles);
            
            // Create source filter buttons
            createSourceFilterButtons(articles);
            
            // Create category filter buttons in header
            createCategoryFilterButtons();
            
            // Create load more button
            createLoadMoreButton();
            
            // Show newsletter button in header
            const headerNewsletterBtn = document.getElementById('headerNewsletterBtn');
            if (headerNewsletterBtn) {
                headerNewsletterBtn.classList.remove('hidden');
            }
            
            renderArticlesWithNumbers(articles);
        }
        
        function renderArticlesWithNumbers(articles) {
            const container = document.getElementById('newsletterArea');
            if (!container) {
                console.error('Newsletter area container not found');
                return;
            }
            
            // Ensure the container is visible
            container.style.display = 'block';
            container.style.visibility = 'visible';
            
            const showSourceInfo = localStorage.getItem('showSourceInfo') !== 'false';
            const showCategories = localStorage.getItem('showCategories') !== 'false';
            const viewMode = localStorage.getItem('viewMode') || 'row';

            container.innerHTML = articles.map((article, index) => {
                const breakingClass = article.isBreaking ? 'breaking-news' : '';
                const breakingBadge = article.isBreaking ? '<span class="breaking-tag">Breaking</span>' : '';
                const articleNumber = index + 1;
                
                if (viewMode === 'row') {
                    // Row view - horizontal layout with image on the right
                    const imageHtml = article.imageUrl ? 
                        `<div class="flex-shrink-0 ml-6 md:ml-6">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-32 h-24 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article id="article-${articleNumber}" class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <div class="flex">
                                <div class="flex-grow min-w-0">
                                    <header class="mb-3">
                                        <div class="flex flex-wrap gap-2 mb-2">
                                            ${breakingBadge}
                                            ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                        </div>
                                        <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                            <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                                ${article.title}
                                            </a>
                                        </h2>
                                        ${showSourceInfo ? `
                                        <div class="text-sm text-gray-500">
                                            <span class="feed-source">${article.source}</span>
                                        </div>
                                        ` : ''}
                                    </header>
                                    <div class="content-area">
                                        ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                            <span class="w-4 h-4 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-1">
                                                AI
                                            </span>
                                            Summarized by AI
                                        </div>` : ''}
                                        <div class="text-gray-700 leading-relaxed">
                                            ${article.aiSummary}
                                        </div>
                                        <div class="mt-4 pt-3 border-t border-gray-100">
                                            <button onclick="generateSingleArticleAudio(${articleNumber})" class="single-audio-btn px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-colors">
                                                🎵 Generate Audio
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                ${imageHtml}
                            </div>
                        </article>`;
                } else {
                    // Grid view - vertical layout with image on top
                    const imageHtml = article.imageUrl ? 
                        `<div class="mb-4">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article id="article-${articleNumber}" class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <div class="mb-4">
                                <div class="flex-grow">
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        ${breakingBadge}
                                        ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                    </div>
                                    <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                        <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                            ${article.title}
                                        </a>
                                    </h2>
                                    ${showSourceInfo ? `
                                    <div class="text-sm text-gray-500">
                                        <span class="feed-source">${article.source}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ${imageHtml}
                            <div class="flex-grow">
                                ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                    <span class="w-4 h-4 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-1">
                                        AI
                                    </span>
                                    Summarized by AI
                                </div>` : ''}
                                <div class="text-gray-700 leading-relaxed">
                                    ${article.aiSummary}
                                </div>
                                <div class="mt-4 pt-3 border-t border-gray-100">
                                    <button onclick="generateSingleArticleAudio(${articleNumber})" class="single-audio-btn px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-colors">
                                        🎵 Generate Audio
                                    </button>
                                </div>
                            </div>
                            <footer class="mt-4 pt-4 border-t border-gray-100">
                                <p class="text-xs text-gray-400">
                                    Published: ${new Date(article.pubDate).toLocaleDateString()}
                                </p>
                            </footer>
                        </article>
                    `;
                }
            }).join('');
        }

        function createSourceFilterButtons(articles) {
            // Check if articles exist and have valid data
            if (!articles || !Array.isArray(articles) || articles.length === 0) {
                console.warn('No articles provided to createSourceFilterButtons');
                return;
            }
            
            // Get unique sources from articles
            const sources = [...new Set(articles.map(article => article.source).filter(Boolean))].sort();
            
            // Create filter container if it doesn't exist
            let filterContainer = document.getElementById('sourceFilterContainer');
            if (!filterContainer) {
                const newsletterArea = document.getElementById('newsletterArea');
                if (!newsletterArea || !newsletterArea.parentNode) {
                    console.warn('Newsletter area not found for source filter buttons');
                    return;
                }
                
                filterContainer = document.createElement('div');
                filterContainer.id = 'sourceFilterContainer';
                filterContainer.className = 'mb-6 p-4 bg-gray-50 rounded-lg';
                
                newsletterArea.parentNode.insertBefore(filterContainer, newsletterArea);
            }
            
            // Create filter buttons
            const filterButtons = sources.map(source => 
                `<button onclick="filterBySource('${source}')" 
                         class="source-filter-btn px-3 py-1 m-1 bg-white border border-gray-300 rounded-full text-sm hover:bg-blue-50 hover:border-blue-300 transition-colors">
                    ${source}
                </button>`
            ).join('');
            
            filterContainer.innerHTML = `
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-sm font-medium text-gray-700 mr-2">Filter by source:</span>
                    <button onclick="showAllSources()" 
                            class="source-filter-btn px-3 py-1 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700 transition-colors">
                        All Sources
                    </button>
                    ${filterButtons}
                </div>
            `;
        }
        
        function filterBySource(sourceName) {
            const filteredArticles = window.currentDisplayedArticles.filter(article => article.source === sourceName);
            renderFilteredArticles(filteredArticles);
            
            // Update button states
            document.querySelectorAll('.source-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'border-gray-300');
            });
            
            event.target.classList.remove('bg-white', 'border-gray-300');
            event.target.classList.add('bg-blue-600', 'text-white');
            
            showToast(`Showing ${filteredArticles.length} articles from ${sourceName}`, 'info');
        }
        
        function showAllSources() {
            renderFilteredArticles(window.currentDisplayedArticles);
            
            // Update button states
            document.querySelectorAll('.source-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'border-gray-300');
            });
            
            event.target.classList.remove('bg-white', 'border-gray-300');
            event.target.classList.add('bg-blue-600', 'text-white');
            
            showToast(`Showing all ${window.currentDisplayedArticles.length} articles`, 'info');
        }
        
        function renderFilteredArticles(articles) {
            // Update article index when filtering
            createArticleIndex(articles);
            
            // Use the same rendering function for consistency
            renderArticlesWithNumbers(articles);
        }
        
        function renderFilteredArticlesOld(articles) {
            const container = document.getElementById('newsletterArea');
            const showSourceInfo = localStorage.getItem('showSourceInfo') !== 'false';
            const showCategories = localStorage.getItem('showCategories') !== 'false';
            const viewMode = localStorage.getItem('viewMode') || 'row';

            container.innerHTML = articles.map((article, index) => {
                const breakingClass = article.isBreaking ? 'breaking-news' : '';
                const breakingBadge = article.isBreaking ? '<span class="breaking-tag">Breaking</span>' : '';
                
                if (viewMode === 'row') {
                    // Row view - horizontal layout with image on the left
                    const imageHtml = article.imageUrl ? 
                        `<div class="flex-shrink-0 mr-6">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-32 h-24 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <div class="flex">
                                ${imageHtml}
                                <div class="flex-grow">
                                    <header class="mb-3">
                                        <div class="flex flex-wrap gap-2 mb-2">
                                            ${breakingBadge}
                                            ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                        </div>
                                        <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                            <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                                ${article.title}
                                            </a>
                                        </h2>
                                        ${showSourceInfo ? `
                                        <div class="text-sm text-gray-500">
                                            <span class="feed-source">${article.source}</span>
                                        </div>
                                        ` : ''}
                                    </header>
                                    <div class="content-area">
                                        ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                            </svg>
                                            Summarized by AI
                                        </div>` : ''}
                                        <div class="text-gray-700 leading-relaxed">
                                            ${article.aiSummary}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>`;
                } else {
                    // Grid view - vertical layout with image on top
                    const imageHtml = article.imageUrl ? 
                        `<div class="mb-4">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            ${imageHtml}
                            <header class="mb-3">
                                <div class="flex flex-wrap gap-2 mb-2">
                                    ${breakingBadge}
                                    ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                </div>
                                <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                    <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                        ${article.title}
                                    </a>
                                </h2>
                                ${showSourceInfo ? `
                                <div class="text-sm text-gray-500">
                                    <span class="feed-source">${article.source}</span>
                                </div>
                                ` : ''}
                            </header>
                            <div class="content-area">
                                ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                    </svg>
                                    Summarized by AI
                                </div>` : ''}
                                <div class="text-gray-700 leading-relaxed">
                                    ${article.aiSummary}
                                </div>
                            </div>
                        </article>`;
                }
            }).join('');
        }

        function createArticleIndex(articles) {
            const indexContainer = document.getElementById('articleIndex');
            const indexList = document.getElementById('indexList');
            
            // Check if elements exist before using them
            if (!indexContainer || !indexList) {
                console.warn('Article index elements not found in DOM');
                return;
            }
            
            if (articles.length === 0) {
                indexContainer.style.display = 'none';
                return;
            }
            
            indexList.innerHTML = articles.map((article, index) => {
                const articleNumber = index + 1;
                const title = article.title || 'No title';
                return `
                    <div class="cursor-pointer hover:text-blue-600 transition-colors" onclick="scrollToArticle(${articleNumber})">
                        <span class="font-medium">${articleNumber}.</span> ${title.substring(0, 60)}${title.length > 60 ? '...' : ''}
                    </div>
                `;
            }).join('');
            
            indexContainer.style.display = 'block';
        }
        
        function scrollToArticle(articleNumber) {
            const article = document.getElementById(`article-${articleNumber}`);
            if (article) {
                article.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Briefly highlight the article
                article.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
                setTimeout(() => {
                    article.style.boxShadow = '';
                }, 2000);
            }
        }

        async function generateSingleArticleAudio(articleNumber) {
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            if (!geminiApiKey) {
                showToast('Please configure your Google API key in settings for Text-to-Speech', 'error');
                return;
            }

            const articles = window.currentDisplayedArticles;
            if (!articles || articles.length === 0) {
                showToast('No articles available', 'error');
                return;
            }

            const article = articles[articleNumber - 1];
            if (!article) {
                showToast('Article not found', 'error');
                return;
            }

            const button = document.querySelector(`article#article-${articleNumber} .single-audio-btn`);
            if (!button) return;

            // Update button state
            button.disabled = true;
            button.innerHTML = '⏳ Generating...';

            try {
                // Create text content for TTS
                const textContent = `${article.title}. ${article.aiSummary}`;
                
                // Generate audio using Google TTS
                const audioBlob = await generateTTSAudio(textContent, geminiApiKey);
                
                if (audioBlob) {
                    // Replace button with audio player and auto-play
                    replaceButtonWithAudioPlayer(articleNumber, audioBlob, true);
                } else {
                    throw new Error('Failed to generate audio');
                }
            } catch (error) {
                console.error('Error generating audio:', error);
                showToast('Error generating audio. Please check your API key.', 'error');
                
                // Reset button
                button.disabled = false;
                button.innerHTML = '🎵 Generate Audio';
            }
        }

        async function generateAudioForArticles() {
            const articles = window.currentDisplayedArticles;
            if (!articles || articles.length === 0) {
                showToast('No articles to convert to audio', 'error');
                return;
            }

            showToast('Generating audio for articles...', 'info');
            
            // Add audio controls container
            addAudioControlsContainer();
            
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            
            try {
                for (let i = 0; i < articles.length; i++) {
                    const article = articles[i];
                    const articleNumber = i + 1;
                    
                    // Create text content for TTS (skip index)
                    const textContent = `Article ${articleNumber}. ${article.title}. ${article.aiSummary}`;
                    
                    // Generate audio using Google TTS
                    const audioBlob = await generateTTSAudio(textContent, geminiApiKey);
                    
                    if (audioBlob) {
                        // Add audio player to article
                        addAudioPlayerToArticle(articleNumber, audioBlob);
                    }
                }
                
                showToast('Audio generation completed!', 'success');
            } catch (error) {
                console.error('Error generating audio:', error);
                showToast('Error generating audio. Please check your API key.', 'error');
            }
        }

        async function generateTTSAudio(text, apiKey) {
            try {
                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: { text: text },
                        voice: {
                            languageCode: 'en-US',
                            name: 'en-US-Standard-D', // Cheapest male voice
                            ssmlGender: 'MALE'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 1.0,
                            pitch: 0.0
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.audioContent) {
                    // Convert base64 to blob
                    const audioBytes = atob(data.audioContent);
                    const audioArray = new Uint8Array(audioBytes.length);
                    for (let i = 0; i < audioBytes.length; i++) {
                        audioArray[i] = audioBytes.charCodeAt(i);
                    }
                    return new Blob([audioArray], { type: 'audio/mp3' });
                }
                
                return null;
            } catch (error) {
                console.error('TTS generation failed:', error);
                return null;
            }
        }

        function addAudioControlsContainer() {
            let audioContainer = document.getElementById('audioControlsContainer');
            if (!audioContainer) {
                audioContainer = document.createElement('div');
                audioContainer.id = 'audioControlsContainer';
                audioContainer.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mb-6';
                audioContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-green-800">Audio Newsletter</h3>
                        <div class="flex gap-2">
                            <button onclick="playAllAudio()" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Play All</button>
                            <button onclick="stopAllAudio()" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">Stop All</button>
                        </div>
                    </div>
                    <p class="text-sm text-green-700">Audio controls have been added to each article. Use the play buttons below or the controls above to listen to the newsletter.</p>
                `;
                
                const newsletterArea = document.getElementById('newsletterArea');
                newsletterArea.parentNode.insertBefore(audioContainer, newsletterArea);
            }
        }

        function replaceButtonWithAudioPlayer(articleNumber, audioBlob, autoPlay = false) {
            const article = document.getElementById(`article-${articleNumber}`);
            if (!article) return;

            const audioUrl = URL.createObjectURL(audioBlob);
            const buttonContainer = article.querySelector('.single-audio-btn').parentElement;
            
            if (!buttonContainer) return;

            // Replace the button with audio player
            buttonContainer.innerHTML = `
                <div class="flex items-center gap-3">
                    <button onclick="toggleSingleAudio(${articleNumber})" class="audio-play-btn w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center hover:bg-green-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 5v10l7-5z"/>
                        </svg>
                    </button>
                    <audio id="audio-${articleNumber}" preload="metadata">
                        <source src="${audioUrl}" type="audio/mp3">
                    </audio>
                    <span class="text-sm text-green-700">Listen to Article ${articleNumber}</span>
                </div>
            `;

            // Auto-play if requested
            if (autoPlay) {
                setTimeout(() => {
                    toggleSingleAudio(articleNumber);
                }, 100);
            }
        }

        function toggleSingleAudio(articleNumber) {
            const audio = document.getElementById(`audio-${articleNumber}`);
            const button = audio.parentElement.querySelector('.audio-play-btn');
            
            if (audio.paused) {
                // Stop all other audio first
                stopAllSingleAudio();
                audio.play();
                button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4h2v12H6V4zm6 0h2v12h-2V4z"/></svg>';
            } else {
                audio.pause();
                button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l7-5z"/></svg>';
            }
        }

        function stopAllSingleAudio() {
            const audioElements = document.querySelectorAll('[id^="audio-"]');
            audioElements.forEach(audio => {
                if (!audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                    const button = audio.parentElement?.querySelector('.audio-play-btn');
                    if (button) {
                        button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l7-5z"/></svg>';
                    }
                }
            });
        }

        function playAllAudio() {
            const articles = window.currentDisplayedArticles;
            if (!articles) return;
            
            let currentIndex = 0;
            
            function playNext() {
                if (currentIndex >= articles.length) return;
                
                const articleNumber = currentIndex + 1;
                const audio = document.getElementById(`audio-${articleNumber}`);
                
                if (audio) {
                    audio.addEventListener('ended', () => {
                        currentIndex++;
                        playNext();
                    }, { once: true });
                    
                    toggleAudio(articleNumber);
                }
            }
            
            playNext();
        }

        function stopAllAudio() {
            const articles = window.currentDisplayedArticles;
            if (!articles) return;
            
            for (let i = 0; i < articles.length; i++) {
                const articleNumber = i + 1;
                const audio = document.getElementById(`audio-${articleNumber}`);
                const button = audio?.parentElement?.querySelector('.audio-play-btn');
                
                if (audio && !audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                    if (button) {
                        button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l7-5z"/></svg>';
                    }
                }
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleFloatingButtons() {
            const scrollButton = document.getElementById('scrollToTop');
            
            // Show scroll button when scrolled down
            if (window.scrollY > 300) {
                scrollButton.style.display = 'flex';
            } else {
                scrollButton.style.display = 'none';
            }
        }

        // Add scroll event listener for floating buttons
        window.addEventListener('scroll', toggleFloatingButtons);
        window.addEventListener('resize', toggleFloatingButtons);

        function createCategoryFilterButtons() {
            // Only create category filter buttons when articles are displayed
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection && welcomeSection.style.display !== 'none') {
                return; // Don't create filter buttons on welcome page
            }
            
            // Remove existing category filter container if it exists
            const existingContainer = document.getElementById('categoryFilterContainer');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // Get all available categories
            const categories = [...new Set(currentRssFeeds.map(feed => feed.category).filter(Boolean))].sort();
            
            if (categories.length === 0) return;
            
            // Create category filter container
            const filterContainer = document.createElement('div');
            filterContainer.id = 'categoryFilterContainer';
            filterContainer.className = 'mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg';
            
            // Create category filter buttons
            const categoryButtons = categories.map(category => 
                `<button onclick="toggleCategoryFilter('${category.toLowerCase()}')" 
                         class="category-filter-btn px-3 py-2 m-1 bg-white border border-blue-300 rounded-lg text-sm hover:bg-blue-100 transition-colors"
                         data-category="${category.toLowerCase()}">
                    ${category}
                </button>`
            ).join('');
            
            filterContainer.innerHTML = `
                <div class="flex flex-wrap items-center gap-2 mb-3">
                    <span class="text-sm font-medium text-blue-800 mr-2">Refresh with different categories:</span>
                    <div class="flex flex-wrap gap-1">
                        ${categoryButtons}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="refreshSelectedCategories" onclick="refreshWithSelectedCategories()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors" style="display: none;">
                        Refresh with Selected Categories
                    </button>
                    <button onclick="clearCategorySelection()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600 transition-colors">
                        Clear Selection
                    </button>
                </div>
            `;
            
            // Insert before newsletter area
            const newsletterArea = document.getElementById('newsletterArea');
            if (newsletterArea && newsletterArea.parentNode) {
                newsletterArea.parentNode.insertBefore(filterContainer, newsletterArea);
            }
        }
        
        let selectedFilterCategories = [];
        
        function toggleCategoryFilter(categoryName) {
            const button = event.target;
            
            if (selectedFilterCategories.includes(categoryName)) {
                // Remove category
                selectedFilterCategories = selectedFilterCategories.filter(cat => cat !== categoryName);
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('bg-white', 'border-blue-300');
            } else {
                // Add category
                selectedFilterCategories.push(categoryName);
                button.classList.remove('bg-white', 'border-blue-300');
                button.classList.add('bg-blue-600', 'text-white');
            }
            
            // Show/hide refresh button
            const refreshBtn = document.getElementById('refreshSelectedCategories');
            if (refreshBtn) {
                if (selectedFilterCategories.length > 0) {
                    refreshBtn.style.display = 'inline-block';
                    refreshBtn.textContent = `Refresh with ${selectedFilterCategories.length} Categories`;
                } else {
                    refreshBtn.style.display = 'none';
                }
            }
        }
        
        function clearCategorySelection() {
            selectedFilterCategories = [];
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'border-blue-300');
            });
            
            const refreshBtn = document.getElementById('refreshSelectedCategories');
            if (refreshBtn) {
                refreshBtn.style.display = 'none';
            }
        }
        
        function refreshWithSelectedCategories() {
            if (selectedFilterCategories.length === 0) return;
            
            // Clear previous content
            clearPreviousContent();
            
            // Generate newsletter with selected categories
            if (selectedFilterCategories.length === 1) {
                // Single category - use existing dropdown logic
                document.getElementById('categorySelect').value = selectedFilterCategories[0];
                generateNewsletter();
            } else {
                // Multiple categories - use custom filtering
                generateNewsletterForCategories(selectedFilterCategories);
            }
        }

        function createLoadMoreButton() {
            // Remove existing load more button if it exists
            const existingButton = document.getElementById('loadMoreContainer');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Check if newsletter area exists
            const newsletterArea = document.getElementById('newsletterArea');
            if (!newsletterArea || !newsletterArea.parentNode) {
                console.warn('Newsletter area not found for load more button');
                return;
            }
            
            // Create load more container
            const loadMoreContainer = document.createElement('div');
            loadMoreContainer.id = 'loadMoreContainer';
            loadMoreContainer.className = 'mt-8 text-center';
            
            loadMoreContainer.innerHTML = `
                <button id="loadMoreBtn" onclick="loadMoreArticles()" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Load More Articles
                </button>
                <div id="loadMoreLoader" class="hidden mt-4">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="ml-2 text-gray-600">Loading more articles...</span>
                </div>
            `;
            
            // Insert after newsletter area
            newsletterArea.parentNode.insertBefore(loadMoreContainer, newsletterArea.nextSibling);
        }

        async function loadMoreArticles() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadMoreLoader = document.getElementById('loadMoreLoader');
            
            // Show loading state with witty message
            const moreLoadingMessages = [
                "Digging deeper into the news archives...",
                "Asking reporters for their secret stash...",
                "Searching for stories you haven't seen yet...",
                "Convincing more servers to share their news...",
                "Finding the articles hiding behind page 2...",
                "Collecting bonus content from the internet...",
                "Discovering stories that thought they were safe...",
                "Expanding the news universe just for you...",
                "Hunting for fresh content in digital corners...",
                "Summoning additional news from the void..."
            ];
            
            const randomMessage = moreLoadingMessages[Math.floor(Math.random() * moreLoadingMessages.length)];
            loadMoreLoader.querySelector('span').textContent = randomMessage;
            
            loadMoreBtn.style.display = 'none';
            loadMoreLoader.classList.remove('hidden');
            
            try {
                // Get current category and settings
                const category = document.getElementById('categorySelect').value;
                const maxArticles = 20;
                const digestLength = 'brief';
                
                // Filter feeds by category
                let feedsToUse = currentRssFeeds;
                if (category !== 'all') {
                    feedsToUse = currentRssFeeds.filter(feed => 
                        feed.category.toLowerCase().includes(category.toLowerCase()) ||
                        category.toLowerCase().includes(feed.category.toLowerCase())
                    );
                }

                // Fetch new articles (fetch more to account for filtering and duplicates)
                const newArticles = await fetchArticlesFromFeeds(feedsToUse, maxArticles * 6);
                
                if (newArticles.length === 0) {
                    showToast('No more articles available', 'info');
                    loadMoreBtn.textContent = 'No More Articles';
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    loadMoreBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    loadMoreBtn.style.display = 'block';
                    loadMoreLoader.classList.add('hidden');
                    return;
                }

                // Filter out articles that are already displayed (check by title and link)
                const currentTitles = new Set(window.currentDisplayedArticles.map(a => a.title.toLowerCase()));
                const currentLinks = new Set(window.currentDisplayedArticles.map(a => a.link));
                
                const uniqueNewArticles = newArticles.filter(article => 
                    !currentTitles.has(article.title.toLowerCase()) && 
                    !currentLinks.has(article.link)
                );

                if (uniqueNewArticles.length === 0) {
                    showToast('No new unique articles found', 'info');
                    loadMoreBtn.textContent = 'No More Articles';
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    loadMoreBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    loadMoreBtn.style.display = 'block';
                    loadMoreLoader.classList.add('hidden');
                    return;
                }

                // Apply blocked terms filter
                const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
                const cleanArticles = filterBlockedTerms(uniqueNewArticles, blockedTerms);

                // Remove duplicate articles within the new batch
                const uniqueCleanArticles = removeDuplicateArticles(cleanArticles);

                // Sort articles with breaking news first
                const sortedArticles = sortArticlesWithBreakingFirst(uniqueCleanArticles);

                // Limit to maxArticles
                const finalNewArticles = sortedArticles.slice(0, maxArticles);

                // Generate AI summaries for new articles
                const processedNewArticles = await generateAISummaries(finalNewArticles, digestLength, category);

                // Add new articles to the current displayed articles
                window.currentDisplayedArticles = [...window.currentDisplayedArticles, ...processedNewArticles];

                // Append new articles to the display
                appendNewArticles(processedNewArticles);
                
                // Update source filter buttons to include new sources
                createSourceFilterButtons(window.currentDisplayedArticles);

                showToast(`Loaded ${processedNewArticles.length} new articles`, 'success');
                
            } catch (error) {
                console.error('Error loading more articles:', error);
                showToast('Error loading more articles', 'error');
            } finally {
                // Hide loading state and show button again
                loadMoreBtn.style.display = 'block';
                loadMoreLoader.classList.add('hidden');
            }
        }

        function appendNewArticles(newArticles) {
            const container = document.getElementById('newsletterArea');
            const showSourceInfo = localStorage.getItem('showSourceInfo') !== 'false';
            const showCategories = localStorage.getItem('showCategories') !== 'false';
            const viewMode = localStorage.getItem('viewMode') || 'row';

            const newArticlesHtml = newArticles.map(article => {
                const breakingClass = article.isBreaking ? 'breaking-news' : '';
                const breakingBadge = article.isBreaking ? '<span class="breaking-tag">Breaking</span>' : '';
                
                if (viewMode === 'row') {
                    // Row view - horizontal layout with image on the left
                    const imageHtml = article.imageUrl ? 
                        `<div class="flex-shrink-0 mr-6">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-32 h-24 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <div class="flex">
                                ${imageHtml}
                                <div class="flex-grow">
                                    <header class="mb-3">
                                        <div class="flex flex-wrap gap-2 mb-2">
                                            ${breakingBadge}
                                            ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                        </div>
                                        <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                            <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                                ${article.title}
                                            </a>
                                        </h2>
                                        ${showSourceInfo ? `
                                        <div class="text-sm text-gray-500">
                                            <span class="feed-source">${article.source}</span>
                                        </div>
                                        ` : ''}
                                    </header>
                                    <div class="content-area">
                                        ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                            </svg>
                                            Summarized by AI
                                        </div>` : ''}
                                        <div class="text-gray-700 leading-relaxed">
                                            ${article.aiSummary}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>`;
                } else {
                    // Grid view - vertical layout with image on top
                    const imageHtml = article.imageUrl ? 
                        `<div class="mb-4">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            ${imageHtml}
                            <header class="mb-3">
                                <div class="flex flex-wrap gap-2 mb-2">
                                    ${breakingBadge}
                                    ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                </div>
                                <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                    <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                        ${article.title}
                                    </a>
                                </h2>
                                ${showSourceInfo ? `
                                <div class="text-sm text-gray-500">
                                    <span class="feed-source">${article.source}</span>
                                </div>
                                ` : ''}
                            </header>
                            <div class="content-area">
                                ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                    </svg>
                                    Summarized by AI
                                </div>` : ''}
                                <div class="text-gray-700 leading-relaxed">
                                    ${article.aiSummary}
                                </div>
                            </div>
                        </article>`;
                }
            }).join('');
            
            // Append new articles to existing content
            container.innerHTML += newArticlesHtml;
        }



        function generateArticleIcon(article) {
            // Generate clean, simple icons based on article category
            const category = article.category.toLowerCase();
            
            // Define simple geometric icons with clean colors
            let iconShape, iconColor;
            
            if (category.includes('technology') || category.includes('tech')) {
                iconShape = `<rect x="8" y="8" width="8" height="8" rx="2" fill="currentColor"/>`;
                iconColor = '#3B82F6';
            } else if (category.includes('business') || category.includes('finance')) {
                iconShape = `<circle cx="12" cy="8" r="3" fill="currentColor"/><circle cx="12" cy="16" r="3" fill="currentColor"/>`;
                iconColor = '#059669';
            } else if (category.includes('sports')) {
                iconShape = `<circle cx="12" cy="12" r="6" fill="currentColor"/>`;
                iconColor = '#DC2626';
            } else if (category.includes('health') || category.includes('science')) {
                iconShape = `<polygon points="12,6 18,12 12,18 6,12" fill="currentColor"/>`;
                iconColor = '#7C3AED';
            } else if (category.includes('entertainment') || category.includes('culture')) {
                iconShape = `<polygon points="8,6 16,6 18,12 16,18 8,18 6,12" fill="currentColor"/>`;
                iconColor = '#F59E0B';
            } else if (category.includes('politics') || category.includes('world')) {
                iconShape = `<rect x="6" y="6" width="12" height="12" rx="1" fill="currentColor"/>`;
                iconColor = '#6366F1';
            } else {
                // Default simple square
                iconShape = `<rect x="7" y="7" width="10" height="10" rx="1" fill="currentColor"/>`;
                iconColor = '#6B7280';
            }
            
            return `
                <svg width="24" height="24" viewBox="0 0 24 24" style="color: ${iconColor};">
                    ${iconShape}
                </svg>
            `;
        }

        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        let statusMessageInterval = null;

        function startRotatingStatusMessages() {
            const wittyMessages = [
                'Fetching and analyzing news articles...',
                'Teaching AI to read faster than you...',
                'Convincing servers to share their secrets...',
                'Filtering out the noise, keeping the gold...',
                'Making sense of the chaos for you...',
                'Turning information overload into clarity...',
                'Brewing your perfect news digest...',
                'Connecting dots across the internet...',
                'Hunting down the most important stories...',
                'Transforming headlines into insights...'
            ];
            
            let messageIndex = 0;
            const statusElement = document.getElementById('statusMessage');
            
            // Set initial message
            statusElement.textContent = wittyMessages[0];
            
            // Clear any existing interval
            if (statusMessageInterval) {
                clearInterval(statusMessageInterval);
            }
            
            // Start rotating messages every 5 seconds
            statusMessageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % wittyMessages.length;
                statusElement.textContent = wittyMessages[messageIndex];
            }, 5000);
        }

        function stopRotatingStatusMessages() {
            if (statusMessageInterval) {
                clearInterval(statusMessageInterval);
                statusMessageInterval = null;
            }
        }

        function getCurrentlyVisibleArticles() {
            // Get articles that are currently visible in the DOM
            const visibleArticleElements = document.querySelectorAll('#newsletterArea .article-card:not([style*="display: none"])');
            const visibleArticles = [];
            
            visibleArticleElements.forEach((element, index) => {
                // Find the corresponding article data
                if (window.currentDisplayedArticles && window.currentDisplayedArticles[index]) {
                    visibleArticles.push(window.currentDisplayedArticles[index]);
                }
            });
            
            // If no visible articles found through DOM, fall back to currentDisplayedArticles
            if (visibleArticles.length === 0 && window.currentDisplayedArticles) {
                return window.currentDisplayedArticles;
            }
            
            return visibleArticles;
        }

        async function generateCustomNewsletter() {
            // Get currently visible articles (filtered articles)
            const visibleArticles = getCurrentlyVisibleArticles();
            
            if (!visibleArticles || visibleArticles.length === 0) {
                showToast('No articles to export', 'error');
                return;
            }

            showToast('Generating newsletter...', 'info');

            // Calculate date range from articles
            const articleDates = visibleArticles
                .map(article => new Date(article.pubDate))
                .filter(date => !isNaN(date))
                .sort((a, b) => a - b);
            
            let dateStr;
            if (articleDates.length > 0) {
                const earliestDate = articleDates[0];
                const latestDate = articleDates[articleDates.length - 1];
                
                const isSameDay = earliestDate.toDateString() === latestDate.toDateString();
                
                if (isSameDay) {
                    dateStr = earliestDate.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else {
                    const earliestDay = earliestDate.getDate();
                    const latestDay = latestDate.getDate();
                    const month = latestDate.toLocaleDateString('en-US', { month: 'long' });
                    const year = latestDate.getFullYear();
                    
                    if (earliestDate.getMonth() === latestDate.getMonth()) {
                        dateStr = `${month} ${earliestDay}${getOrdinalSuffix(earliestDay)} to ${latestDay}${getOrdinalSuffix(latestDay)}, ${year}`;
                    } else {
                        const earliestMonth = earliestDate.toLocaleDateString('en-US', { month: 'long' });
                        dateStr = `${earliestMonth} ${earliestDay}${getOrdinalSuffix(earliestDay)} to ${month} ${latestDay}${getOrdinalSuffix(latestDay)}, ${year}`;
                    }
                }
            } else {
                const today = new Date();
                dateStr = today.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }

            // Get unique categories for header
            const categories = [...new Set(visibleArticles.map(article => article.category || 'General'))];
            const categoryText = categories.join(', ');

            // Group articles by category
            const articlesByCategory = {};
            visibleArticles.forEach(article => {
                const category = article.category || 'General';
                if (!articlesByCategory[category]) {
                    articlesByCategory[category] = [];
                }
                articlesByCategory[category].push(article);
            });

            // Generate newsletter HTML
            let newsletterHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Brief - ${dateStr}</title>
    <style>
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .newsletter-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }
        .date {
            color: #6b7280;
            font-size: 14px;
        }
        .category-section {
            margin-bottom: 40px;
        }
        .category-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            border-left: 4px solid #2563eb;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .article {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #fafafa;
        }
        .article-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .article-icon {
            margin-right: 15px;
            margin-top: 2px;
        }
        .article-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
            line-height: 1.4;
            flex: 1;
        }
        .article-title a {
            color: #2563eb;
            text-decoration: none;
        }
        .article-title a:hover {
            text-decoration: underline;
        }
        .article-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .article-summary {
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }
        .breaking-badge {
            background: #dc2626;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 12px;
        }
        .stats {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
            text-align: center;
        }
        .audio-controls {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .audio-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .audio-button:hover {
            background: #1d4ed8;
        }
        .audio-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="newsletter-container">
        <div class="header">
            <div class="logo">📰 News Brief</div>
            <div class="date">${dateStr}</div>
        </div>
        

        
        <div class="stats">
            <strong>${visibleArticles.length} articles</strong> from <strong>${categoryText}</strong>
        </div>
        
        <!-- Simple Audio Player -->
        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 20px; margin-bottom: 30px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #1e40af;">🎧 Listen to Newsletter</h3>
            <p style="margin: 0 0 15px 0; font-size: 12px; color: #6b7280;">AI-generated audio of your complete newsletter</p>
            <button onclick="generateAudio()" style="background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
                🔊 Generate Audio
            </button>
            <div id="audioPlayer" style="display: none; margin-top: 15px;">
                <audio controls style="width: 100%; max-width: 400px;">
                    <source id="audioSource" src="" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            <div id="audioStatus" style="font-size: 12px; color: #6b7280; margin-top: 10px;"></div>
        </div>
`;

            // Add articles by category
            for (const [category, articles] of Object.entries(articlesByCategory)) {
                newsletterHTML += `
        <div class="category-section">
            <div class="category-title">${category}</div>
`;
                
                articles.forEach(article => {
                    const standardIcon = `<svg width="24" height="24" viewBox="0 0 24 24" style="color: #2563eb;">
                        <rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor" opacity="0.1"/>
                        <rect x="6" y="6" width="12" height="2" rx="1" fill="currentColor"/>
                        <rect x="6" y="9" width="8" height="2" rx="1" fill="currentColor"/>
                        <rect x="6" y="12" width="10" height="2" rx="1" fill="currentColor"/>
                        <rect x="6" y="15" width="6" height="2" rx="1" fill="currentColor"/>
                    </svg>`;
                    const breakingBadge = article.isBreaking ? '<span class="breaking-badge">BREAKING</span>' : '';
                    
                    newsletterHTML += `
            <div class="article">
                <div class="article-header">
                    <div class="article-icon">${standardIcon}</div>
                    <div class="article-title">
                        <a href="${article.link}" target="_blank">${article.title}</a>${breakingBadge}
                    </div>
                </div>
                <div class="article-meta">
                    ${article.source}
                </div>
                <div class="article-summary">
                    ${article.aiSummary || article.description}
                </div>
            </div>
`;
                });
                
                newsletterHTML += `        </div>`;
            }

            newsletterHTML += `
        <div class="footer">
            Generated on ${new Date().toLocaleString()}<br>
            Powered by News Brief • AI-Enhanced News Curation
        </div>
    </div>
    
    <script>
        function generateAudio() {
            const button = event.target;
            const statusDiv = document.getElementById('audioStatus');
            const playerDiv = document.getElementById('audioPlayer');
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '⏳ Generating...';
            statusDiv.textContent = 'Preparing newsletter content for audio generation...';

            // Compile newsletter text from the page
            let newsletterText = 'Today\'s News Brief. ';
            
            // Extract all article content from the page
            const articles = document.querySelectorAll('.article');
            articles.forEach((article, index) => {
                const title = article.querySelector('.article-title');
                const summary = article.querySelector('.article-summary');
                const source = article.querySelector('.article-meta');
                
                if (title) {
                    newsletterText += 'Article ' + (index + 1) + '. ' + title.textContent.trim() + '. ';
                }
                if (summary) {
                    newsletterText += summary.textContent.trim() + ' ';
                }
                if (source) {
                    newsletterText += 'Source: ' + source.textContent.trim() + '. ';
                }
            });

            newsletterText += 'End of newsletter.';

            // Limit text length for TTS
            if (newsletterText.length > 5000) {
                newsletterText = newsletterText.substring(0, 4900) + '... Newsletter content truncated for audio generation.';
            }

            statusDiv.textContent = 'Generating audio with Google Text-to-Speech...';

            // Generate audio using Google TTS
            const encodedText = encodeURIComponent(newsletterText);
            const ttsUrl = 'https://translate.google.com/translate_tts?ie=UTF-8&q=' + encodedText + '&tl=en&client=tw-ob';
            
            // Setup audio player
            const audioElement = playerDiv.querySelector('audio');
            const audioSource = document.getElementById('audioSource');
            
            audioSource.src = ttsUrl;
            audioElement.load();
            
            // Show player and auto-play
            playerDiv.style.display = 'block';
            statusDiv.textContent = 'Audio generated successfully! Playing now...';
            
            // Auto-play the audio
            audioElement.play().then(() => {
                statusDiv.textContent = 'Audio is playing...';
            }).catch(() => {
                statusDiv.textContent = 'Audio ready! Click play to listen.';
            });

            // Update button
            button.innerHTML = '✅ Audio Generated';
            button.disabled = false;
        }
    <\/script>
</body>
</html>`;

            // Show newsletter in modal
            showNewsletterModal(newsletterHTML, visibleArticles.length);
        }

        function showNewsletterModal(newsletterHTML, articleCount) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('newsletterModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'newsletterModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-2">Newsletter Generated</h2>
                                <p class="text-gray-600">Newsletter with <strong id="modalArticleCount"></strong> articles ready for export.</p>
                            </div>
                            <button onclick="closeNewsletterModal()" class="text-gray-400 hover:text-gray-600 ml-4">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 8.586L2.929 1.515 1.515 2.929 8.586 10l-7.071 7.071 1.414 1.414L10 11.414l7.071 7.071 1.414-1.414L11.414 10l7.071-7.071-1.414-1.414L10 8.586z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button onclick="copyNewsletterText()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                                Copy Text
                            </button>
                            <button onclick="copyAndOpenNotebookLM()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm">
                                Copy & Open NotebookLM
                            </button>
                            <button onclick="downloadNewsletter()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
                                Download HTML
                            </button>
                            <button onclick="printNewsletter()" class="w-full px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium text-sm">
                                Print
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Store newsletter HTML globally
            window.currentNewsletterHTML = newsletterHTML;
            
            // Update modal content
            document.getElementById('modalArticleCount').textContent = articleCount;
            
            // Show modal
            modal.classList.remove('hidden');
        }

        function printNewsletter() {
            if (window.currentNewsletterHTML) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(window.currentNewsletterHTML);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }
        }

        function closeNewsletterModal() {
            const modal = document.getElementById('newsletterModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function copyNewsletterText() {
            if (!window.currentNewsletterHTML) {
                showToast('No newsletter to copy', 'error');
                return;
            }

            // Create a clean text version without CSS
            const textContent = generateCleanNewsletterText();

            navigator.clipboard.writeText(textContent).then(() => {
                showToast('Newsletter text copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy text', 'error');
            });
        }

        function copyAndOpenNotebookLM() {
            if (!window.currentNewsletterHTML) {
                showToast('No newsletter to copy', 'error');
                return;
            }

            // Create a clean text version without CSS
            const textContent = generateCleanNewsletterText();

            navigator.clipboard.writeText(textContent).then(() => {
                showToast('Newsletter copied! Opening NotebookLM...', 'success');
                // Open NotebookLM in new tab
                window.open('https://notebooklm.google.com/', '_blank');
            }).catch(() => {
                showToast('Failed to copy text', 'error');
            });
        }

        function generateCleanNewsletterText() {
            if (!window.currentDisplayedArticles) {
                return 'No articles available';
            }

            const articles = window.currentDisplayedArticles;
            const dateStr = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let newsletterText = `News Brief - ${dateStr}\n`;
            newsletterText += `=`.repeat(50) + '\n\n';
            newsletterText += `${articles.length} articles from trusted news sources\n\n`;

            // Group articles by category
            const articlesByCategory = {};
            articles.forEach(article => {
                const category = article.category || 'General';
                if (!articlesByCategory[category]) {
                    articlesByCategory[category] = [];
                }
                articlesByCategory[category].push(article);
            });

            // Add articles by category
            for (const [category, categoryArticles] of Object.entries(articlesByCategory)) {
                newsletterText += `${category.toUpperCase()}\n`;
                newsletterText += `-`.repeat(category.length) + '\n\n';
                
                categoryArticles.forEach((article, index) => {
                    const articleNumber = articles.indexOf(article) + 1;
                    const breakingBadge = article.isBreaking ? ' [BREAKING]' : '';
                    const pubDate = new Date(article.pubDate).toLocaleDateString();
                    
                    newsletterText += `${articleNumber}. ${article.title}${breakingBadge}\n`;
                    newsletterText += `Source: ${article.source} | ${pubDate}\n`;
                    newsletterText += `${article.aiSummary}\n`;
                    if (article.link) {
                        newsletterText += `Read more: ${article.link}\n`;
                    }
                    newsletterText += '\n';
                });
                
                newsletterText += '\n';
            }

            newsletterText += `Generated on ${dateStr} by News Brief\n`;
            return newsletterText;
        }

        function downloadNewsletter() {
            if (!window.currentNewsletterHTML) {
                showToast('No newsletter to download', 'error');
                return;
            }

            const today = new Date();
            const blob = new Blob([window.currentNewsletterHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Open in new tab instead of downloading
            window.open(url, '_blank');
            
            showToast('Newsletter opened in new tab', 'success');
            
            // Clean up after a delay
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 1000);
        }

        let selectedCategories = [];

        function clearPreviousContent() {
            // Clear article content
            document.getElementById('newsletterArea').innerHTML = '';
            
            // Clear article index
            const articleIndex = document.getElementById('articleIndex');
            if (articleIndex) {
                articleIndex.innerHTML = '';
                articleIndex.style.display = 'none';
            }
            
            // Clear source filter buttons and container
            const sourceFilterContainer = document.getElementById('sourceFilterContainer');
            if (sourceFilterContainer) {
                sourceFilterContainer.remove();
            }
            
            // Clear category filter container
            const existingFilterContainer = document.getElementById('categoryFilterContainer');
            if (existingFilterContainer) {
                existingFilterContainer.remove();
            }
            
            // Clear load more button
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (loadMoreContainer) {
                loadMoreContainer.remove();
            }
            
            // Clear any global variables
            window.currentDisplayedArticles = [];
            window.currentNewsletterHTML = '';
            
            // Hide floating buttons
            const audioFab = document.getElementById('audioFab');
            if (audioFab) {
                audioFab.style.display = 'none';
            }
            
            // Reset category filter buttons in header
            const headerFilterContainer = document.getElementById('categoryFilterContainer');
            if (headerFilterContainer) {
                headerFilterContainer.remove();
            }
        }

        function quickCategory(categoryName) {
            // Clear any selected categories
            selectedCategories = [];
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('generateFromSelection').style.display = 'none';
            
            // Clear previous content and filters
            clearPreviousContent();
            
            // Set the category in the dropdown
            document.getElementById('categorySelect').value = categoryName.toLowerCase();
            
            // Hide welcome section and show header controls
            const welcomeSection = document.getElementById('welcomeSection');
            const newsHeader = document.getElementById('newsHeader');
            
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Always show header controls when generating content
            if (newsHeader) {
                newsHeader.style.display = 'block';
            }
            
            // Generate newsletter for selected category
            generateNewsletter();
        }

        function toggleCategory(categoryName) {
            const button = event.target;
            
            if (selectedCategories.includes(categoryName)) {
                // Remove category
                selectedCategories = selectedCategories.filter(cat => cat !== categoryName);
                button.classList.remove('selected');
            } else {
                // Add category
                selectedCategories.push(categoryName);
                button.classList.add('selected');
            }
            
            // Show/hide generate button and update category dropdown
            const generateBtn = document.getElementById('generateFromSelection');
            const categorySelect = document.getElementById('categorySelect');
            
            if (selectedCategories.length > 0) {
                generateBtn.style.display = 'block';
                if (selectedCategories.length === 1) {
                    generateBtn.textContent = `Generate News from ${selectedCategories[0]}`;
                    // Set dropdown to single category
                    categorySelect.value = selectedCategories[0];
                } else {
                    generateBtn.textContent = `Generate News from ${selectedCategories.length} Categories`;
                    // Set dropdown to "all" for multiple categories
                    categorySelect.value = 'all';
                }
            } else {
                generateBtn.style.display = 'none';
                categorySelect.value = 'all';
            }
        }

        function generateFromSelectedCategories() {
            if (selectedCategories.length === 0) return;
            
            // Clear previous content when generating from selected categories
            clearPreviousContent();
            
            // Hide welcome section and show header controls
            const welcomeSection = document.getElementById('welcomeSection');
            const newsHeader = document.getElementById('newsHeader');
            
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            if (newsHeader) {
                newsHeader.style.display = 'block';
            }
            
            // For multiple categories, we need to filter feeds differently
            if (selectedCategories.length === 1) {
                // Single category - use existing dropdown logic
                document.getElementById('categorySelect').value = selectedCategories[0];
                generateNewsletter();
            } else {
                // Multiple categories - use custom filtering
                generateNewsletterForCategories(selectedCategories);
            }
        }

        async function generateNewsletterForCategories(categories) {
            const maxArticles = 20;
            const digestLength = 'brief';

            // Check if API key is configured before starting
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            const apiKey = aiProvider === 'gemini' ? geminiApiKey : openaiApiKey;
            
            if (!apiKey) {
                showToast(`Please configure your ${aiProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API key in settings`, 'error');
                return;
            }

            // Show loading state with rotating messages
            startRotatingStatusMessages();
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('newsletterArea').innerHTML = '';

            try {
                // Filter feeds by categories
                let feedsToUse = currentRssFeeds;
                if (!categories.includes('all') && categories.length > 0) {
                    feedsToUse = currentRssFeeds.filter(feed => {
                        if (!feed.category) return false;
                        const feedCat = feed.category.toLowerCase().trim();
                        return categories.some(category => {
                            const selectedCat = category.toLowerCase().trim();
                            return feedCat === selectedCat;
                        });
                    });
                    
                    // Add local news feeds if local news is selected
                    if (categories.some(cat => cat.toLowerCase() === 'local news')) {
                        const localFeeds = await generateLocalNewsFeeds();
                        feedsToUse = [...feedsToUse, ...localFeeds];
                    }
                    
                    console.log(`Selected categories: ${categories.join(', ')}`);
                    console.log(`Filtered ${feedsToUse.length} feeds for categories`);
                    console.log('Feeds to use:', feedsToUse.map(f => f.name));
                }

                // Fetch articles from RSS feeds with balanced category distribution
                const articles = await fetchArticlesFromFeeds(feedsToUse, maxArticles * 4);
                
                if (articles.length === 0) {
                    document.getElementById('statusMessage').textContent = 'No articles found. Please try again or check your feeds.';
                    document.getElementById('loader').classList.add('hidden');
                    return;
                }

                // Log article distribution by source category for debugging
                const categoryDistribution = {};
                articles.forEach(article => {
                    const feed = feedsToUse.find(f => f.name === article.source);
                    const category = feed ? feed.category : 'Unknown';
                    categoryDistribution[category] = (categoryDistribution[category] || 0) + 1;
                });
                console.log('Article distribution by category:', categoryDistribution);

                // Apply blocked terms filter
                const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
                const cleanArticles = filterBlockedTerms(articles, blockedTerms);

                // Remove duplicate articles and keep the best version
                const uniqueArticles = removeDuplicateArticles(cleanArticles);

                // For multiple categories, ensure balanced representation
                let finalArticles;
                if (categories.length > 1 && !categories.includes('all')) {
                    // Group articles by category
                    const articlesByCategory = {};
                    uniqueArticles.forEach(article => {
                        const feed = feedsToUse.find(f => f.name === article.source);
                        const category = feed ? feed.category : 'Unknown';
                        if (!articlesByCategory[category]) {
                            articlesByCategory[category] = [];
                        }
                        articlesByCategory[category].push(article);
                    });

                    // Take articles proportionally from each category
                    const articlesPerCategory = Math.max(2, Math.floor(maxArticles / categories.length));
                    const balancedArticles = [];
                    
                    // First pass: take articlesPerCategory from each category
                    categories.forEach(category => {
                        const categoryKey = category.charAt(0).toUpperCase() + category.slice(1);
                        const categoryArticles = articlesByCategory[categoryKey] || [];
                        const sorted = sortArticlesWithBreakingFirst(categoryArticles);
                        balancedArticles.push(...sorted.slice(0, articlesPerCategory));
                    });

                    // Second pass: fill remaining slots with any available articles
                    const remainingSlots = maxArticles - balancedArticles.length;
                    if (remainingSlots > 0) {
                        const remainingArticles = uniqueArticles.filter(article => 
                            !balancedArticles.some(existing => existing.id === article.id)
                        );
                        const sortedRemaining = sortArticlesWithBreakingFirst(remainingArticles);
                        balancedArticles.push(...sortedRemaining.slice(0, remainingSlots));
                    }

                    finalArticles = balancedArticles.slice(0, maxArticles);
                    console.log('Balanced article distribution:', 
                        categories.map(cat => {
                            const count = finalArticles.filter(article => {
                                const feed = feedsToUse.find(f => f.name === article.source);
                                return feed && feed.category.toLowerCase() === cat.toLowerCase();
                            }).length;
                            return `${cat}: ${count}`;
                        }).join(', ')
                    );
                } else {
                    // Sort articles with breaking news first
                    const sortedArticles = sortArticlesWithBreakingFirst(uniqueArticles);
                    finalArticles = sortedArticles.slice(0, maxArticles);
                }

                // Generate AI summaries
                console.log('Starting AI processing...');
                const processedArticles = await generateAISummaries(finalArticles, digestLength, 'all');
                console.log('AI processing completed, articles:', processedArticles.length);
                console.log('Final articles to display:', finalArticles.length);

                // Display articles
                console.log('Starting displayArticles...');
                displayArticles(processedArticles);
                console.log('displayArticles completed');

                // Show header and hide welcome section
                document.getElementById('newsHeader').style.display = 'block';
                document.getElementById('welcomeSection').style.display = 'none';

                // Create article index, source filter buttons, load more button, and category filter buttons
                console.log('Creating UI elements...');
                try {
                    createArticleIndex(processedArticles);
                    console.log('Article index created');
                } catch (e) {
                    console.error('Error creating article index:', e);
                }
                
                try {
                    createSourceFilterButtons(processedArticles);
                    console.log('Source filter buttons created');
                } catch (e) {
                    console.error('Error creating source filter buttons:', e);
                }
                
                try {
                    createLoadMoreButton();
                    console.log('Load more button created');
                } catch (e) {
                    console.error('Error creating load more button:', e);
                }
                
                try {
                    createCategoryFilterButtons();
                    console.log('Category filter buttons created');
                } catch (e) {
                    console.error('Error creating category filter buttons:', e);
                }

                // Hide loading state
                stopRotatingStatusMessages();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('statusMessage').textContent = `Generated newsletter with ${processedArticles.length} articles`;

            } catch (error) {
                console.error('Error generating newsletter:', error);
                console.error('Error details:', error.message, error.stack);
                stopRotatingStatusMessages();
                document.getElementById('statusMessage').textContent = 'Error generating newsletter. Please try again.';
                document.getElementById('loader').classList.add('hidden');
                showToast(`Error: ${error.message || 'Unknown error'}`, 'error');
            }
        }

        function clearDisplay() {
            // Clear articles and filters
            document.getElementById('newsletterArea').innerHTML = '';
            document.getElementById('statusMessage').textContent = '';
            
            // Hide article index
            const articleIndex = document.getElementById('articleIndex');
            if (articleIndex) {
                articleIndex.style.display = 'none';
            }
            
            // Hide newsletter audio controls
            const newsletterAudioControls = document.getElementById('newsletterAudioControls');
            if (newsletterAudioControls) {
                newsletterAudioControls.style.display = 'none';
            }
            
            // Remove source filter, load more buttons, category filter, and audio controls if they exist
            const sourceFilter = document.getElementById('sourceFilterContainer');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const categoryFilter = document.getElementById('categoryFilterContainer');
            const audioContainer = document.getElementById('audioControlsContainer');
            if (sourceFilter) sourceFilter.remove();
            if (loadMoreContainer) loadMoreContainer.remove();
            if (categoryFilter) categoryFilter.remove();
            if (audioContainer) audioContainer.remove();
            
            // Reset category selection
            document.getElementById('categorySelect').value = 'all';
            
            // Clear current articles
            window.currentDisplayedArticles = [];
            
            // Hide floating buttons
            document.getElementById('scrollToTop').style.display = 'none';
        }

        function startOver() {
            // Use the same cleanup as homepage navigation
            navigateToHome();
            showToast('Ready to start over!', 'info');
        }

        function filterByCategory(categoryName) {
            // Update the category selector
            document.getElementById('categorySelect').value = categoryName.toLowerCase();
            
            // Store current articles for filtering
            const currentArticles = window.currentDisplayedArticles || [];
            
            if (currentArticles.length > 0) {
                // Filter and re-sort articles by the selected category
                const filteredArticles = currentArticles.filter(article => 
                    article.category.toLowerCase() === categoryName.toLowerCase()
                );
                
                const otherArticles = currentArticles.filter(article => 
                    article.category.toLowerCase() !== categoryName.toLowerCase()
                );
                
                // Display selected category articles first, then others
                const reorderedArticles = [...filteredArticles, ...otherArticles];
                displayArticles(reorderedArticles);
                
                showToast(`Filtered by ${categoryName}`, 'info');
            } else {
                // If no current articles, generate new newsletter with this category
                generateNewsletter();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 400);
            }, 4000);
        }

        function showSettings() {
            document.getElementById('newsPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'block';
        }

        // Initialize page navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Set up navigation buttons
            document.getElementById('navSettings').addEventListener('click', showSettings);
            
            // Set up all settings functionality
            document.getElementById('aiProvider').addEventListener('change', handleAiProviderChange);
            document.getElementById('saveAllSettings').addEventListener('click', saveAllSettings);
            document.getElementById('opmlFile').addEventListener('change', handleOpmlUpload);
            document.getElementById('clearOpml').addEventListener('click', clearOpml);
            document.getElementById('blockedTermInput').addEventListener('keypress', handleBlockedTermInput);
            document.getElementById('generateNewsletter').addEventListener('click', generateNewsletter);
            document.getElementById('startOver').addEventListener('click', startOver);
            
            // Load saved settings
            loadSettings();
        });
    </script>
    
    <!-- Floating Action Buttons -->
    <button id="scrollToTop" class="scroll-to-top" onclick="scrollToTop()" title="Scroll to top">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 2l8 8h-4v8H6v-8H2l8-8z"/>
        </svg>
    </button>
    

    
    <div id="toastContainer"></div>
</body>
</html>