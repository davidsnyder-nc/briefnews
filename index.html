<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>briefnews - AI News Digest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .news-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.3s ease-in-out;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 100%; 
        }
        .news-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .breaking-news {
            border-left: 4px solid #dc3545;
            background: linear-gradient(90deg, rgba(220,53,69,0.1) 0%, rgba(255,255,255,1) 10%);
        }
        .feed-source { color: #5f6368; }
        .category-tag {
            background-color: #e8f0fe; color: #1a73e8;
            font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem;
        }
        .breaking-tag {
            background-color: #dc3545; color: white;
            font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem;
            font-weight: bold; text-transform: uppercase;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #bbb; width: 90%; max-width: 450px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-close-button { color: #888; float: right; font-size: 24px; font-weight: bold; line-height: 0.8; }
        .modal-close-button:hover, .modal-close-button:focus { color: #333; text-decoration: none; cursor: pointer; }

        #toastContainer { position: fixed; bottom: 15px; right: 15px; z-index: 1001; display: flex; flex-direction: column; align-items: flex-end; }
        .toast {
            background-color: #333; color: #fff;
            padding: 10px 15px; border-radius: 5px; margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(15px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            font-size: 0.85rem; max-width: 300px; word-wrap: break-word;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: #c82333; }
        .toast.success { background-color: #218838; }
        .toast.info { background-color: #0069d9; }

        .settings-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .blocked-term-pill {
            display: inline-flex; align-items: center;
            background-color: #e0e0e0; color: #333;
            padding: 5px 10px; margin: 3px; border-radius: 16px; font-size: 0.85rem;
        }
        .blocked-term-pill button {
            background: none; border: none; color: #777; margin-left: 8px;
            font-weight: bold; cursor: pointer; padding: 0; line-height: 1;
        }
        .blocked-term-pill button:hover { color: #333; }
        .page { display: none; }
        .page.active { display: block; }

        .form-input {
            width: 100%; padding: 0.5rem 0.75rem; font-size: 0.9rem;
            border: 1px solid #ced4da; border-radius: 0.25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .form-input:focus {
            border-color: #80bdff; outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .btn {
            display: inline-block; font-weight: 500; color: #fff; text-align: center;
            vertical-align: middle; cursor: pointer; user-select: none;
            background-color: #007bff; border: 1px solid #007bff;
            padding: 0.5rem 1rem; font-size: 0.9rem; line-height: 1.5;
            border-radius: 0.25rem; transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .btn:hover { background-color: #0056b3; border-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; border-color: #545b62; }
        
        .app-title-brief { color: #a0d2eb; }
        .app-title-news { color: #ffffff; }

        #wizardContainer {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 2rem auto;
        }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .wizard-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center; color: #0056b3;}
        .wizard-nav { margin-top: 1.5rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-700 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold">
                <span class="app-title-brief">brief</span><span class="app-title-news">news</span>
            </h1>
            <div>
                <button id="navNews" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-800 focus:outline-none focus:bg-blue-800">News</button>
                <button id="navSettings" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-800 focus:outline-none focus:bg-blue-800">Settings</button>
            </div>
        </div>
    </nav>

    <div id="wizardContainer" class="container mx-auto px-4 py-4">
        <h2 class="wizard-title">Welcome to briefnews! Let's get you started.</h2>
        
        <div id="wizardStep1" class="wizard-step active">
            <h3 class="text-lg font-medium mb-3">Step 1: Choose a News Category</h3>
            <label for="wizardCategorySelect" class="form-label">Category:</label>
            <select id="wizardCategorySelect" class="form-input w-full mb-4">
                <option value="all">All Categories</option>
                <option value="world news">World News</option>
                <option value="technology">Technology</option>
                <option value="business">Business</option>
                <option value="sports">Sports</option>
                <option value="science">Science</option>
                <option value="health">Health</option>
                <option value="entertainment">Entertainment</option>
                <option value="politics">Politics</option>
                <option value="lifestyle">Lifestyle</option>
                <option value="education">Education</option>
                <option value="environment">Environment</option>
                <option value="food">Food & Cooking</option>
                <option value="travel">Travel</option>
                <option value="finance">Personal Finance</option>
                <option value="gaming">Gaming</option>
                <option value="general">General</option>
            </select>
            <div class="wizard-nav">
                <span></span> <button id="wizardNextToStep2" class="btn">Next &rarr;</button>
            </div>
        </div>

        <div id="wizardStep2" class="wizard-step">
            <h3 class="text-lg font-medium mb-3">Step 2: Get Your Briefing!</h3>
            <p class="mb-4 text-gray-600">You're all set! Click below to get your personalized news briefing.</p>
            <p class="mb-4"><strong class="text-gray-700">Selected Category:</strong> <span id="wizardConfirmCategory">All</span></p>
            <div class="wizard-nav">
                <button id="wizardPrevToStep1" class="btn btn-secondary">&larr; Previous</button>
                <button id="wizardBriefMe" class="btn">Brief Me!</button>
            </div>
        </div>
    </div>


    <div id="newsPage" class="page container mx-auto px-4 py-4">
        <header class="bg-white shadow-sm rounded-lg p-4 mb-6" id="newsHeader" style="display: none;">
            <div class="flex gap-4 items-center justify-center">
                <div class="flex items-center gap-2">
                    <label for="categorySelect" class="form-label text-gray-700">Category:</label>
                    <select id="categorySelect" class="form-input">
                        <option value="all">All Categories</option>
                        <option value="world news">World News</option>
                        <option value="technology">Technology</option>
                        <option value="business">Business</option>
                        <option value="sports">Sports</option>
                        <option value="science">Science</option>
                        <option value="health">Health</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="politics">Politics</option>
                        <option value="lifestyle">Lifestyle</option>
                        <option value="education">Education</option>
                        <option value="environment">Environment</option>
                        <option value="food">Food & Cooking</option>
                        <option value="travel">Travel</option>
                        <option value="finance">Personal Finance</option>
                        <option value="gaming">Gaming</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <button id="generateNewsletter" class="btn">Refresh</button>
                <button id="startOver" class="btn btn-secondary">Start Over</button>
            </div>
        </header>

        <div id="statusArea" class="text-center mb-4">
            <p id="statusMessage" class="text-gray-600"></p>
            <div id="loader" class="loader hidden"></div>
        </div>

        <div id="welcomeSection" class="mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg p-8 mb-6 relative">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold mb-4">Welcome to briefnews</h2>
                        <p class="text-lg mb-4">Your AI-powered news digest from only trusted sources</p>
                    </div>
                    <div class="hidden md:block opacity-40">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 6C4 4.89543 4.89543 4 6 4H18C19.1046 4 20 4.89543 20 6V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6Z" stroke="currentColor" stroke-width="1.5" fill="currentColor"/>
                            <path d="M8 8H16M8 12H16M8 16H12" stroke="#1e40af" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white bg-opacity-20 rounded-lg p-4">
                        <h3 class="font-semibold text-lg">Smart Summaries</h3>
                        <p class="text-sm opacity-90">AI-generated summaries tailored to your preferences</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4">
                        <h3 class="font-semibold text-lg">Breaking News Priority</h3>
                        <p class="text-sm opacity-90">Important updates appear first automatically</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4">
                        <h3 class="font-semibold text-lg">Multiple Categories</h3>
                        <p class="text-sm opacity-90">Technology, Business, Science, Sports, and more</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Start</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-full">
                        <h4 class="font-medium text-gray-700 mb-3">Choose Your News Category</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="categoryButtons">
                            <button onclick="quickCategory('all')" class="category-button special px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-blue-700 transition-all shadow-sm">All Categories</button>
                            <button onclick="quickCategory('technology')" class="category-button px-4 py-3 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors border border-blue-200">Technology</button>
                            <button onclick="quickCategory('world news')" class="category-button px-4 py-3 bg-green-50 text-green-700 rounded-lg text-sm font-medium hover:bg-green-100 transition-colors border border-green-200">World News</button>
                            <button onclick="quickCategory('business')" class="category-button px-4 py-3 bg-purple-50 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-100 transition-colors border border-purple-200">Business</button>
                            <button onclick="quickCategory('science')" class="category-button px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium hover:bg-indigo-100 transition-colors border border-indigo-200">Science</button>
                            <button onclick="quickCategory('health')" class="category-button px-4 py-3 bg-red-50 text-red-700 rounded-lg text-sm font-medium hover:bg-red-100 transition-colors border border-red-200">Health</button>
                            <button onclick="quickCategory('politics')" class="category-button px-4 py-3 bg-gray-50 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors border border-gray-200">Politics</button>
                            <button onclick="quickCategory('sports')" class="category-button px-4 py-3 bg-orange-50 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-100 transition-colors border border-orange-200">Sports</button>
                            <button onclick="quickCategory('entertainment')" class="category-button px-4 py-3 bg-pink-50 text-pink-700 rounded-lg text-sm font-medium hover:bg-pink-100 transition-colors border border-pink-200">Entertainment</button>
                            <button onclick="quickCategory('lifestyle')" class="category-button px-4 py-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm font-medium hover:bg-yellow-100 transition-colors border border-yellow-200">Lifestyle</button>
                            <button onclick="quickCategory('education')" class="category-button px-4 py-3 bg-teal-50 text-teal-700 rounded-lg text-sm font-medium hover:bg-teal-100 transition-colors border border-teal-200">Education</button>
                            <button onclick="quickCategory('environment')" class="category-button px-4 py-3 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-medium hover:bg-emerald-100 transition-colors border border-emerald-200">Environment</button>
                            <button onclick="quickCategory('food')" class="category-button px-4 py-3 bg-amber-50 text-amber-700 rounded-lg text-sm font-medium hover:bg-amber-100 transition-colors border border-amber-200">Food & Cooking</button>
                            <button onclick="quickCategory('travel')" class="category-button px-4 py-3 bg-cyan-50 text-cyan-700 rounded-lg text-sm font-medium hover:bg-cyan-100 transition-colors border border-cyan-200">Travel</button>
                            <button onclick="quickCategory('finance')" class="category-button px-4 py-3 bg-violet-50 text-violet-700 rounded-lg text-sm font-medium hover:bg-violet-100 transition-colors border border-violet-200">Personal Finance</button>
                            <button onclick="quickCategory('gaming')" class="category-button px-4 py-3 bg-rose-50 text-rose-700 rounded-lg text-sm font-medium hover:bg-rose-100 transition-colors border border-rose-200">Gaming</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main id="newsletterArea" class="grid grid-cols-1 gap-6">
            </main>
    </div>

    <div id="settingsPage" class="page container mx-auto px-4 py-4">
        <h2 class="text-2xl font-semibold mb-6 text-gray-700">Settings</h2>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">AI Provider Configuration</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="aiProvider" class="form-label">AI Provider:</label>
                    <select id="aiProvider" class="form-input">
                        <option value="gemini" selected>Google Gemini</option>
                        <option value="openai">OpenAI ChatGPT</option>
                    </select>
                </div>
                <div id="geminiConfig">
                    <label for="geminiApiKey" class="form-label">Gemini API Key:</label>
                    <input type="password" id="geminiApiKey" class="form-input" placeholder="Enter your Gemini API Key">
                    <p class="text-xs text-gray-500 mt-1">Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
                </div>
                <div id="openaiConfig" style="display: none;">
                    <label for="openaiApiKey" class="form-label">OpenAI API Key:</label>
                    <input type="password" id="openaiApiKey" class="form-input" placeholder="Enter your OpenAI API Key">
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a></p>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">API keys stored in browser local storage. <strong class="text-red-500">Note: Not secure for production.</strong></p>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">RSS Feeds (OPML)</h3>
            <p class="text-xs text-gray-500 mb-2">Upload an OPML file for custom RSS feeds. Cleared OPML uses defaults.</p>
            <input type="file" id="opmlFile" accept=".opml,.xml" class="form-input mb-2">
            <div id="opmlFileInfo" class="text-sm text-gray-600 mb-2"></div>
            <button id="clearOpml" class="btn btn-secondary btn-sm">Clear Uploaded OPML</button>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Blocked Terms</h3>
            <p class="text-xs text-gray-500 mb-2">Block news containing these terms. Enter term and press Enter to add.</p>
            <input type="text" id="blockedTermInput" class="form-input mb-2" placeholder="Enter term to block...">
            <div id="blockedTermsList" class="min-h-6"></div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Newsletter Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="maxArticles" class="form-label">Max Articles (2-20):</label>
                    <input type="number" id="maxArticles" class="form-input" min="2" max="20" value="20">
                </div>
                <div>
                    <label for="digestLength" class="form-label">AI Digest Length:</label>
                    <select id="digestLength" class="form-input">
                        <option value="brief" selected>Brief</option>
                        <option value="medium">Medium</option>
                        <option value="detailed">Detailed</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <label class="flex items-center">
                    <input type="checkbox" id="aiRewrite" class="mr-2">
                    <span>AI Rewrite: Transform articles into polished, easy-to-read stories</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">When enabled, AI will completely rewrite news articles for better clarity and engagement rather than just summarizing them.</p>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">AI Processing Style</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="aiStyle" class="form-label">Writing Style:</label>
                    <select id="aiStyle" class="form-input">
                        <option value="professional">Professional & Neutral</option>
                        <option value="conversational" selected>Conversational & Engaging</option>
                        <option value="analytical">Analytical & In-depth</option>
                        <option value="simple">Simple & Easy to Read</option>
                    </select>
                </div>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Content Enhancement</h3>
            <div class="grid grid-cols-1 gap-4">
                <label class="flex items-center">
                    <input type="checkbox" id="addContext" class="mr-2" checked>
                    <span>Add background context to stories</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="includeImpact" class="mr-2" checked>
                    <span>Include impact analysis and implications</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="addQuestions" class="mr-2">
                    <span>Add thought-provoking questions</span>
                </label>
            </div>
        </section>
        <section class="settings-section">
            <h3 class="text-lg font-medium mb-3 text-gray-600">Display Preferences</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="form-label">Article Layout:</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center">
                            <input type="radio" name="viewMode" value="row" id="viewModeRow" class="mr-2" checked>
                            <span>Row View</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="viewMode" value="grid" id="viewModeGrid" class="mr-2">
                            <span>Grid View</span>
                        </label>
                    </div>
                </div>
                <label class="flex items-center">
                    <input type="checkbox" id="showSourceInfo" class="mr-2" checked>
                    <span>Show source information</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="showCategories" class="mr-2" checked>
                    <span>Show category tags</span>
                </label>
            </div>
        </section>
        <div class="text-center">
            <button id="saveAllSettings" class="btn bg-green-600 border-green-600 hover:bg-green-700 hover:border-green-700 px-6 py-2">
                Save All Settings
            </button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <div id="saveConfirmModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h3 class="text-lg font-semibold mb-4">Settings Saved</h3>
            <p class="mb-4">Your settings have been saved successfully!</p>
            <button id="modalOkButton" class="btn">OK</button>
        </div>
    </div>

    <script>
        const DEFAULT_OPML = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
<head>
    <title>Verified RSS Feeds - Expanded</title>
    <dateCreated>Sun, 01 Jun 2025 11:16:00 GMT</dateCreated>
</head>
<body>
    <outline text="Feeds" title="Feeds">
        <outline text="General News" title="General News">
            <outline text="The New York Times" type="rss" xmlUrl="https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml"/>
            <outline text="CNN Top Stories" type="rss" xmlUrl="http://rss.cnn.com/rss/cnn_topstories.rss"/>
            <outline text="NPR News" type="rss" xmlUrl="https://feeds.npr.org/1001/rss.xml"/>
            <outline text="CBS News" type="rss" xmlUrl="https://www.cbsnews.com/latest/rss/main"/>
            <outline text="Associated Press" type="rss" xmlUrl="https://feeds.apnews.com/rss/apf-topnews"/>
        </outline>
        <outline text="Technology" title="Technology">
            <outline text="TechCrunch" type="rss" xmlUrl="https://techcrunch.com/feed/"/>
            <outline text="WIRED" type="rss" xmlUrl="https://www.wired.com/feed/rss"/>
            <outline text="The Verge" type="rss" xmlUrl="https://www.theverge.com/rss/index.xml"/>
            <outline text="CNET News" type="rss" xmlUrl="https://www.cnet.com/rss/news/"/>
            <outline text="Ars Technica" type="rss" xmlUrl="http://feeds.arstechnica.com/arstechnica/index"/>
            <outline text="VentureBeat" type="rss" xmlUrl="https://venturebeat.com/feed/"/>
            <outline text="Gizmodo" type="rss" xmlUrl="https://gizmodo.com/rss"/>
            <outline text="Digital Trends" type="rss" xmlUrl="https://www.digitaltrends.com/feed/"/>
            <outline text="Engadget" type="rss" xmlUrl="https://www.engadget.com/rss.xml"/>
            <outline text="How-To Geek" type="rss" xmlUrl="https://www.howtogeek.com/feed/"/>
            <outline text="Hacker News" type="rss" xmlUrl="https://news.ycombinator.com/rss"/>
            <outline text="Slashdot" type="rss" xmlUrl="http://rss.slashdot.org/Slashdot/slashdotMain"/>
        </outline>
        <outline text="Business" title="Business">
            <outline text="Wall Street Journal" type="rss" xmlUrl="https://feeds.a.dj.com/rss/RSSMarketsMain.xml"/>
            <outline text="Forbes" type="rss" xmlUrl="https://www.forbes.com/innovation/feed/"/>
            <outline text="Reuters Business" type="rss" xmlUrl="https://feeds.reuters.com/reuters/businessNews"/>
            <outline text="Financial Times" type="rss" xmlUrl="https://www.ft.com/rss/home"/>
            <outline text="MarketWatch" type="rss" xmlUrl="https://feeds.content.dowjones.io/public/rss/mw_topstories"/>
            <outline text="Bloomberg" type="rss" xmlUrl="https://feeds.bloomberg.com/markets/news.rss"/>
            <outline text="Harvard Business Review" type="rss" xmlUrl="https://hbr.org/rss/regular"/>
        </outline>
        <outline text="Science" title="Science">
            <outline text="Live Science" type="rss" xmlUrl="https://www.livescience.com/feeds/all"/>
            <outline text="Space.com" type="rss" xmlUrl="https://www.space.com/feeds/all"/>
            <outline text="Phys.org" type="rss" xmlUrl="https://phys.org/rss-feed/"/>
            <outline text="New Scientist" type="rss" xmlUrl="https://www.newscientist.com/feed/home/"/>
            <outline text="Scientific American" type="rss" xmlUrl="http://rss.sciam.com/ScientificAmerican-Global"/>
            <outline text="Nature" type="rss" xmlUrl="https://www.nature.com/nature/current-issue/rss"/>
            <outline text="ScienceDaily" type="rss" xmlUrl="https://www.sciencedaily.com/rss/all.xml"/>
        </outline>
        <outline text="Health" title="Health">
            <outline text="MedlinePlus What's New" type="rss" xmlUrl="https://medlineplus.gov/feeds/whatsnew.xml"/>
            <outline text="MedlinePlus New Topics" type="rss" xmlUrl="https://medlineplus.gov/groupfeeds/new.xml"/>
            <outline text="Harvard Health Publishing" type="rss" xmlUrl="https://www.health.harvard.edu/blog/rss"/>
            <outline text="Mayo Clinic News Network" type="rss" xmlUrl="https://newsnetwork.mayoclinic.org/feed/"/>
            <outline text="CDC Health News" type="rss" xmlUrl="https://tools.cdc.gov/podcasts/rss.asp"/>
            <outline text="WebMD Health" type="rss" xmlUrl="https://rssfeeds.webmd.com/rss/rss.aspx?RSSSource=RSS_PUBLIC"/>
            <outline text="Kaiser Health News" type="rss" xmlUrl="https://khn.org/feed/"/>
        </outline>
        <outline text="Politics" title="Politics">
            <outline text="Politico" type="rss" xmlUrl="https://www.politico.com/rss/politicopicks.xml"/>
            <outline text="The Hill" type="rss" xmlUrl="https://thehill.com/rss/syndicator/19109"/>
            <outline text="Washington Post Politics" type="rss" xmlUrl="http://feeds.washingtonpost.com/rss/politics"/>
            <outline text="NPR Politics" type="rss" xmlUrl="https://www.npr.org/rss/rss.php?id=1014"/>
            <outline text="CNN Politics" type="rss" xmlUrl="http://rss.cnn.com/rss/cnn_allpolitics.rss"/>
        </outline>
        <outline text="Sports" title="Sports">
            <outline text="ESPN" type="rss" xmlUrl="https://www.espn.com/espn/rss/news"/>
            <outline text="CBS Sports" type="rss" xmlUrl="https://www.cbssports.com/rss/headlines"/>
            <outline text="Yahoo Sports" type="rss" xmlUrl="https://sports.yahoo.com/rss/"/>
            <outline text="Sports Illustrated" type="rss" xmlUrl="https://www.si.com/rss/si_topstories.rss"/>
            <outline text="NBC Sports" type="rss" xmlUrl="https://scores.nbcsports.com/rss/headlines.asp"/>
        </outline>
        <outline text="Entertainment" title="Entertainment">
            <outline text="Variety" type="rss" xmlUrl="https://variety.com/feed/"/>
            <outline text="Rolling Stone" type="rss" xmlUrl="https://www.rollingstone.com/music/music-news/feed/"/>
            <outline text="Hollywood Reporter" type="rss" xmlUrl="https://www.hollywoodreporter.com/t/rss"/>
            <outline text="Entertainment Weekly" type="rss" xmlUrl="https://ew.com/feed/"/>
            <outline text="TMZ" type="rss" xmlUrl="https://www.tmz.com/rss.xml"/>
        </outline>
        <outline text="Lifestyle" title="Lifestyle">
            <outline text="Lifehacker" type="rss" xmlUrl="https://lifehacker.com/rss"/>
            <outline text="Apartment Therapy" type="rss" xmlUrl="https://www.apartmenttherapy.com/main.rss"/>
            <outline text="The Spruce" type="rss" xmlUrl="https://www.thespruce.com/rss"/>
            <outline text="Better Homes &amp; Gardens" type="rss" xmlUrl="https://www.bhg.com/rss/all/"/>
            <outline text="Real Simple" type="rss" xmlUrl="https://www.realsimple.com/rss/all/"/>
        </outline>
        <outline text="Education" title="Education">
            <outline text="Education Week" type="rss" xmlUrl="https://feeds.edweek.org/edweek/topstories"/>
            <outline text="Inside Higher Ed" type="rss" xmlUrl="https://www.insidehighered.com/rss/news"/>
            <outline text="Chronicle of Higher Education" type="rss" xmlUrl="https://www.chronicle.com/section/Home/5/rss"/>
            <outline text="The Hechinger Report" type="rss" xmlUrl="https://hechingerreport.org/feed/"/>
            <outline text="EdSurge" type="rss" xmlUrl="https://www.edsurge.com/rss"/>
        </outline>
        <outline text="Environment" title="Environment">
            <outline text="TreeHugger" type="rss" xmlUrl="https://www.treehugger.com/rss"/>
            <outline text="Grist" type="rss" xmlUrl="https://grist.org/feed/"/>
            <outline text="Inside Climate News" type="rss" xmlUrl="https://insideclimatenews.org/feed/"/>
            <outline text="Yale Environment 360" type="rss" xmlUrl="https://e360.yale.edu/rss"/>
            <outline text="Environmental Defense Fund" type="rss" xmlUrl="https://www.edf.org/rss.xml"/>
        </outline>
        <outline text="World News" title="World News">
            <outline text="BBC World" type="rss" xmlUrl="http://feeds.bbci.co.uk/news/world/rss.xml"/>
            <outline text="Al Jazeera" type="rss" xmlUrl="https://www.aljazeera.com/xml/rss/all.xml"/>
            <outline text="The Guardian World" type="rss" xmlUrl="https://www.theguardian.com/world/rss"/>
            <outline text="Reuters World News" type="rss" xmlUrl="https://feeds.reuters.com/reuters/worldnews"/>
            <outline text="NPR World" type="rss" xmlUrl="https://feeds.npr.org/1004/rss.xml"/>
            <outline text="Associated Press World" type="rss" xmlUrl="https://rsshub.app/apnews/topics/world-news"/>
            <outline text="Der Spiegel International" type="rss" xmlUrl="https://www.spiegel.de/international/index.rss"/>
        </outline>
        <outline text="Local News" title="Local News">
            <outline text="Google News - North Carolina" type="rss" xmlUrl="https://news.google.com/rss/search?q=North+Carolina+news&amp;hl=en&amp;gl=US&amp;ceid=US:en"/>
            <outline text="ABC11 Raleigh" type="rss" xmlUrl="https://abc11.com/feed/"/>
        </outline>
        <outline text="Food &amp; Cooking" title="Food &amp; Cooking">
            <outline text="Serious Eats" type="rss" xmlUrl="https://www.seriouseats.com/feeds/latest"/>
            <outline text="Allrecipes" type="rss" xmlUrl="https://www.allrecipes.com/feeds/all"/>
            <outline text="Bon Appétit" type="rss" xmlUrl="https://www.bonappetit.com/feed/recipes-rss-2.0/site"/>
        </outline>
        <outline text="Travel" title="Travel">
            <outline text="Condé Nast Traveler" type="rss" xmlUrl="https://www.cntraveler.com/rss"/>
            <outline text="Travel + Leisure" type="rss" xmlUrl="https://www.travelandleisure.com/feeds/all/rss"/>
            <outline text="Nomadic Matt" type="rss" xmlUrl="https://www.nomadicmatt.com/feed/"/>
        </outline>
        <outline text="Personal Finance" title="Personal Finance">
            <outline text="NerdWallet" type="rss" xmlUrl="https://www.nerdwallet.com/feed"/>
            <outline text="The Motley Fool" type="rss" xmlUrl="https://www.fool.com/feed/atom"/>
            <outline text="Money Under 30" type="rss" xmlUrl="https://www.moneyunder30.com/feed/"/>
        </outline>
        <outline text="Gaming" title="Gaming">
            <outline text="IGN" type="rss" xmlUrl="https://feeds.ign.com/ign/all"/>
            <outline text="GameSpot" type="rss" xmlUrl="https://www.gamespot.com/feeds/mashup/"/>
            <outline text="Kotaku" type="rss" xmlUrl="https://kotaku.com/rss"/>
        </outline>
        <outline text="Podcasts" title="Podcasts">
            <outline text="This American Life" type="rss" xmlUrl="http://feed.thisamericanlife.org/talpodcast"/>
            <outline text="Radiolab" type="rss" xmlUrl="http://feeds.wnyc.org/radiolab"/>
            <outline text="Freakonomics Radio" type="rss" xmlUrl="http://feeds.feedburner.com/freakonomicsradio"/>
        </outline>
    </outline>
</body>
</opml>`;

        let currentRssFeeds = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadSettings();
            bindEvents();
            
            // Always show the news page with welcome section now
            // Users can configure API keys in settings if needed
            showNews();
        }

        function bindEvents() {
            // Navigation
            document.getElementById('navNews').addEventListener('click', showNews);
            document.getElementById('navSettings').addEventListener('click', showSettings);

            // Wizard navigation
            document.getElementById('wizardNextToStep2').addEventListener('click', () => {
                const category = document.getElementById('wizardCategorySelect').value;
                
                document.getElementById('wizardConfirmCategory').textContent = 
                    category === 'all' ? 'All Categories' : category.charAt(0).toUpperCase() + category.slice(1);
                
                document.getElementById('wizardStep1').classList.remove('active');
                document.getElementById('wizardStep2').classList.add('active');
            });

            document.getElementById('wizardPrevToStep1').addEventListener('click', () => {
                document.getElementById('wizardStep2').classList.remove('active');
                document.getElementById('wizardStep1').classList.add('active');
            });

            document.getElementById('wizardBriefMe').addEventListener('click', () => {
                const category = document.getElementById('wizardCategorySelect').value;
                
                // Set main page selector
                document.getElementById('categorySelect').value = category;
                
                showNews();
                generateNewsletter();
            });

            // Newsletter generation
            document.getElementById('generateNewsletter').addEventListener('click', generateNewsletter);
            document.getElementById('startOver').addEventListener('click', startOver);

            // Settings
            document.getElementById('saveAllSettings').addEventListener('click', saveAllSettings);
            document.getElementById('opmlFile').addEventListener('change', handleOpmlUpload);
            document.getElementById('clearOpml').addEventListener('click', clearOpml);
            document.getElementById('blockedTermInput').addEventListener('keypress', handleBlockedTermInput);
            document.getElementById('aiProvider').addEventListener('change', handleAiProviderChange);
            
            // View mode controls
            document.getElementById('viewModeRow').addEventListener('change', updateViewMode);
            document.getElementById('viewModeGrid').addEventListener('change', updateViewMode);

            // Modal
            document.getElementById('modalOkButton').addEventListener('click', closeModal);
            document.querySelector('.modal-close-button').addEventListener('click', closeModal);
        }

        function showWizard() {
            document.getElementById('wizardContainer').style.display = 'block';
            document.getElementById('newsPage').classList.remove('active');
            document.getElementById('settingsPage').classList.remove('active');
        }

        function showNews() {
            document.getElementById('wizardContainer').style.display = 'none';
            document.getElementById('newsPage').classList.add('active');
            document.getElementById('settingsPage').classList.remove('active');
        }

        function showSettings() {
            document.getElementById('wizardContainer').style.display = 'none';
            document.getElementById('newsPage').classList.remove('active');
            document.getElementById('settingsPage').classList.add('active');
        }

        function loadSettings() {
            // Load and parse OPML feeds
            const storedOpml = localStorage.getItem('opmlData');
            if (storedOpml) {
                parseOpml(storedOpml);
                document.getElementById('opmlFileInfo').textContent = 'Custom OPML loaded';
            } else {
                parseOpml(DEFAULT_OPML);
                document.getElementById('opmlFileInfo').textContent = 'Using default feeds (139+ sources)';
            }

            // Load AI provider and API keys
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            document.getElementById('aiProvider').value = aiProvider;
            
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            if (geminiApiKey) document.getElementById('geminiApiKey').value = geminiApiKey;
            
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            if (openaiApiKey) document.getElementById('openaiApiKey').value = openaiApiKey;
            
            // Show/hide appropriate config section
            handleAiProviderChange();

            const maxArticles = localStorage.getItem('maxArticles') || '20';
            document.getElementById('maxArticles').value = maxArticles;

            const digestLength = localStorage.getItem('digestLength') || 'brief';
            document.getElementById('digestLength').value = digestLength;

            const showSourceInfo = localStorage.getItem('showSourceInfo');
            document.getElementById('showSourceInfo').checked = showSourceInfo !== 'false';

            const showCategories = localStorage.getItem('showCategories');
            document.getElementById('showCategories').checked = showCategories !== 'false';

            // Load AI rewrite settings
            const aiRewrite = localStorage.getItem('aiRewrite');
            document.getElementById('aiRewrite').checked = aiRewrite === 'true';
            
            const aiStyle = localStorage.getItem('aiStyle') || 'conversational';
            document.getElementById('aiStyle').value = aiStyle;
            
            const addContext = localStorage.getItem('addContext');
            document.getElementById('addContext').checked = addContext !== 'false';
            
            const includeImpact = localStorage.getItem('includeImpact');
            document.getElementById('includeImpact').checked = includeImpact !== 'false';
            
            const addQuestions = localStorage.getItem('addQuestions');
            document.getElementById('addQuestions').checked = addQuestions === 'true';

            // Load view mode preference - default to row view
            const viewMode = localStorage.getItem('viewMode') || 'row';
            if (viewMode === 'row') {
                document.getElementById('viewModeRow').checked = true;
            } else {
                document.getElementById('viewModeGrid').checked = true;
            }
            updateViewMode();

            // Load blocked terms
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            displayBlockedTerms(blockedTerms);
        }

        function saveAllSettings() {
            // Save AI provider and API keys
            localStorage.setItem('aiProvider', document.getElementById('aiProvider').value);
            
            const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            if (geminiApiKey) {
                localStorage.setItem('geminiApiKey', geminiApiKey);
            }
            
            const openaiApiKey = document.getElementById('openaiApiKey').value.trim();
            if (openaiApiKey) {
                localStorage.setItem('openaiApiKey', openaiApiKey);
            }

            // Save other settings
            localStorage.setItem('maxArticles', document.getElementById('maxArticles').value);
            localStorage.setItem('digestLength', document.getElementById('digestLength').value);
            localStorage.setItem('showSourceInfo', document.getElementById('showSourceInfo').checked);
            localStorage.setItem('showCategories', document.getElementById('showCategories').checked);
            
            // Save AI rewrite settings
            localStorage.setItem('aiRewrite', document.getElementById('aiRewrite').checked);
            localStorage.setItem('aiStyle', document.getElementById('aiStyle').value);
            localStorage.setItem('addContext', document.getElementById('addContext').checked);
            localStorage.setItem('includeImpact', document.getElementById('includeImpact').checked);
            localStorage.setItem('addQuestions', document.getElementById('addQuestions').checked);

            // Show toast notification and navigate to home
            showToast('Settings saved successfully!', 'success');
            showNews();
        }

        function handleAiProviderChange() {
            const provider = document.getElementById('aiProvider').value;
            const geminiConfig = document.getElementById('geminiConfig');
            const openaiConfig = document.getElementById('openaiConfig');
            
            if (provider === 'gemini') {
                geminiConfig.style.display = 'block';
                openaiConfig.style.display = 'none';
            } else {
                geminiConfig.style.display = 'none';
                openaiConfig.style.display = 'block';
            }
        }

        function closeModal() {
            document.getElementById('saveConfirmModal').style.display = 'none';
            showNews();
        }

        function handleOpmlUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const opmlContent = e.target.result;
                    parseOpml(opmlContent);
                    localStorage.setItem('opmlData', opmlContent);
                    document.getElementById('opmlFileInfo').textContent = `Custom OPML loaded: ${file.name}`;
                    showToast('OPML file loaded successfully', 'success');
                };
                reader.readAsText(file);
            }
        }

        function clearOpml() {
            localStorage.removeItem('opmlData');
            parseOpml(DEFAULT_OPML);
            document.getElementById('opmlFile').value = '';
            document.getElementById('opmlFileInfo').textContent = 'Using default feeds (139+ sources)';
            showToast('Cleared custom OPML, using default feeds', 'info');
        }

        function parseOpml(opmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(opmlContent, 'text/xml');
                const outlines = xmlDoc.querySelectorAll('outline[type="rss"]');
                
                currentRssFeeds = Array.from(outlines).map(outline => ({
                    title: outline.getAttribute('text'),
                    url: outline.getAttribute('xmlUrl'),
                    category: outline.parentElement.getAttribute('text') || 'general'
                }));
                
                console.log(`Loaded ${currentRssFeeds.length} RSS feeds`);
            } catch (error) {
                console.error('Error parsing OPML:', error);
                showToast('Error loading OPML file', 'error');
            }
        }

        function handleBlockedTermInput(event) {
            if (event.key === 'Enter') {
                const term = event.target.value.trim().toLowerCase();
                if (term) {
                    addBlockedTerm(term);
                    event.target.value = '';
                }
            }
        }

        function addBlockedTerm(term) {
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            if (!blockedTerms.includes(term)) {
                blockedTerms.push(term);
                localStorage.setItem('blockedTerms', JSON.stringify(blockedTerms));
                displayBlockedTerms(blockedTerms);
                showToast(`Blocked term added: ${term}`, 'success');
            }
        }

        function removeBlockedTerm(term) {
            const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
            const filtered = blockedTerms.filter(t => t !== term);
            localStorage.setItem('blockedTerms', JSON.stringify(filtered));
            displayBlockedTerms(filtered);
            showToast(`Blocked term removed: ${term}`, 'info');
        }

        function displayBlockedTerms(terms) {
            const container = document.getElementById('blockedTermsList');
            container.innerHTML = terms.map(term => 
                `<span class="blocked-term-pill">
                    ${term}
                    <button onclick="removeBlockedTerm('${term}')">&times;</button>
                </span>`
            ).join('');
        }

        function updateViewMode() {
            const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
            localStorage.setItem('viewMode', viewMode);
            
            const newsletterArea = document.getElementById('newsletterArea');
            if (viewMode === 'grid') {
                newsletterArea.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            } else {
                newsletterArea.className = 'grid grid-cols-1 gap-6';
            }
        }

        async function generateNewsletter() {
            const category = document.getElementById('categorySelect').value;
            const maxArticles = parseInt(localStorage.getItem('maxArticles') || '20');
            const digestLength = localStorage.getItem('digestLength') || 'brief';

            // Check if API key is configured before starting
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            const apiKey = aiProvider === 'gemini' ? geminiApiKey : openaiApiKey;
            
            if (!apiKey) {
                showToast(`Please configure your ${aiProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API key in settings`, 'error');
                return;
            }

            // Show loading state
            document.getElementById('statusMessage').textContent = 'Fetching and analyzing news articles...';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('newsletterArea').innerHTML = '';

            try {
                // Filter feeds by category
                let feedsToUse = currentRssFeeds;
                if (category !== 'all') {
                    feedsToUse = currentRssFeeds.filter(feed => 
                        feed.category.toLowerCase().includes(category.toLowerCase()) ||
                        category.toLowerCase().includes(feed.category.toLowerCase())
                    );
                }

                // Fetch articles from RSS feeds (fetch more to account for filtering)
                const articles = await fetchArticlesFromFeeds(feedsToUse, maxArticles * 4);
                
                if (articles.length === 0) {
                    throw new Error('No articles found for the selected criteria');
                }

                // Apply blocked terms filter
                const blockedTerms = JSON.parse(localStorage.getItem('blockedTerms') || '[]');
                const cleanArticles = filterBlockedTerms(articles, blockedTerms);

                // Remove duplicate articles and keep the best version
                const uniqueArticles = removeDuplicateArticles(cleanArticles);

                // Sort articles with breaking news first
                const sortedArticles = sortArticlesWithBreakingFirst(uniqueArticles);

                // Limit to max articles
                const finalArticles = sortedArticles.slice(0, maxArticles);

                // Generate AI summaries
                const processedArticles = await generateAISummaries(finalArticles, digestLength, category);

                // Display articles
                displayArticles(processedArticles);

                document.getElementById('statusMessage').textContent = `Generated ${processedArticles.length} article summaries`;
                
            } catch (error) {
                console.error('Error generating newsletter:', error);
                document.getElementById('statusMessage').textContent = 'Error generating newsletter';
                const errorMessage = error.message || 'An unexpected error occurred';
                showToast(`Error: ${errorMessage}`, 'error');
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function filterArticlesByDate(articles, dateRange) {
            if (dateRange === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return articles.filter(article => {
                    const articleDate = new Date(article.pubDate);
                    return articleDate >= today;
                });
            }
            return articles; // 'anytime' returns all articles
        }

        function sortArticlesWithBreakingFirst(articles) {
            return articles.sort((a, b) => {
                // Check if articles contain breaking news keywords
                const aIsBreaking = isBreakingNews(a);
                const bIsBreaking = isBreakingNews(b);
                
                // ALWAYS prioritize breaking news first regardless of other sorting
                if (aIsBreaking && !bIsBreaking) return -1;
                if (!aIsBreaking && bIsBreaking) return 1;
                
                // If both or neither are breaking, sort by date (newest first)
                return new Date(b.pubDate) - new Date(a.pubDate);
            });
        }

        function isBreakingNews(article) {
            // Only apply breaking news to general news and world news categories
            const allowedCategories = ['general news', 'world news', 'general'];
            const isAllowedCategory = allowedCategories.some(cat => 
                article.category.toLowerCase().includes(cat.toLowerCase())
            );
            
            if (!isAllowedCategory) {
                return false;
            }
            
            const breakingKeywords = [
                'breaking', 'urgent', 'alert', 'developing', 'live', 'just in',
                'emergency', 'crisis', 'explosion', 'attack', 'disaster', 
                'confirmed dead', 'killed', 'warning', 'critical situation'
            ];
            
            const text = (article.title + ' ' + (article.description || '')).toLowerCase();
            const hasBreakingKeyword = breakingKeywords.some(keyword => text.includes(keyword));
            
            // Only mark as breaking if it has explicit breaking keywords AND is recent (last 4 hours)
            const articleDate = new Date(article.pubDate);
            const fourHoursAgo = new Date(Date.now() - 4 * 60 * 60 * 1000);
            const isRecent = articleDate > fourHoursAgo;
            
            return hasBreakingKeyword && isRecent;
        }

        function filterBlockedTerms(articles, blockedTerms) {
            if (blockedTerms.length === 0) return articles;
            
            return articles.filter(article => {
                const text = (article.title + ' ' + article.description).toLowerCase();
                return !blockedTerms.some(term => text.includes(term));
            });
        }

        function removeDuplicateArticles(articles) {
            const uniqueArticles = [];
            const seenTitles = new Set();
            
            // Sort by source quality and recency to pick the best version
            const sortedArticles = articles.sort((a, b) => {
                // Prefer sources with longer content
                const aLength = (a.fullContent || a.description || '').length;
                const bLength = (b.fullContent || b.description || '').length;
                if (aLength !== bLength) return bLength - aLength;
                
                // Then prefer more recent articles
                return new Date(b.pubDate) - new Date(a.pubDate);
            });
            
            for (const article of sortedArticles) {
                const titleWords = article.title.toLowerCase().split(' ').filter(word => word.length > 3);
                const titleKey = titleWords.slice(0, 5).join(' '); // Use first 5 significant words
                
                // Check if we've seen a similar title
                let isDuplicate = false;
                for (const seenTitle of seenTitles) {
                    const similarity = calculateSimilarity(titleKey, seenTitle);
                    if (similarity > 0.7) { // 70% similarity threshold
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    seenTitles.add(titleKey);
                    uniqueArticles.push(article);
                }
            }
            
            return uniqueArticles;
        }

        function calculateSimilarity(str1, str2) {
            const words1 = str1.split(' ');
            const words2 = str2.split(' ');
            const commonWords = words1.filter(word => words2.includes(word));
            return commonWords.length / Math.max(words1.length, words2.length);
        }

        function cleanHtmlContent(text) {
            if (!text) return '';
            // Remove HTML tags and decode entities
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || '';
        }

        async function fetchArticlesFromFeeds(feeds, maxArticles) {
            const articles = [];
            const corsProxy = 'https://api.allorigins.win/get?url=';
            
            // Process feeds in parallel with larger batch size for more articles
            const feedPromises = feeds.slice(0, 25).map(async (feed) => {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // Balanced timeout
                    
                    const response = await fetch(corsProxy + encodeURIComponent(feed.url), {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) return [];
                    
                    const data = await response.json();
                    const xmlText = data.contents;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    
                    if (xmlDoc.querySelector('parsererror')) return [];
                    
                    const items = xmlDoc.querySelectorAll('item');
                    const feedArticles = [];
                    
                    for (const item of Array.from(items).slice(0, 3)) {
                        const rawTitle = item.querySelector('title')?.textContent || 'No Title';
                        const rawDescription = item.querySelector('description')?.textContent || '';
                        const rawContent = item.querySelector('content\\:encoded')?.textContent || rawDescription;
                        
                        // Improved image extraction with fallback filtering
                        let imageUrl = '';
                        
                        const enclosure = item.querySelector('enclosure[type^="image"]');
                        if (enclosure) {
                            imageUrl = enclosure.getAttribute('url');
                        }
                        
                        if (!imageUrl) {
                            const mediaContent = item.querySelector('media\\:content[medium="image"], media\\:content[type^="image"]');
                            if (mediaContent) {
                                imageUrl = mediaContent.getAttribute('url');
                            }
                        }
                        
                        if (!imageUrl) {
                            const imgMatch = (rawContent || rawDescription).match(/<img[^>]+src=["']([^"']+)["']/i);
                            if (imgMatch) {
                                const imgSrc = imgMatch[1];
                                // Filter out social media icons and generic images
                                if (!imgSrc.includes('twitter.com') && !imgSrc.includes('facebook.com') && 
                                    !imgSrc.includes('icon') && !imgSrc.includes('logo') && 
                                    !imgSrc.includes('avatar') && imgSrc.length > 30) {
                                    imageUrl = imgSrc;
                                }
                            }
                        }
                        
                        const cleanContent = cleanHtmlContent(rawContent || rawDescription);
                        
                        if (cleanContent.length > 50) {
                            const article = {
                                title: cleanHtmlContent(rawTitle),
                                description: cleanContent.substring(0, 500),
                                fullContent: cleanContent,
                                link: item.querySelector('link')?.textContent || '',
                                pubDate: item.querySelector('pubDate')?.textContent || new Date().toISOString(),
                                source: feed.title,
                                category: feed.category,
                                imageUrl: imageUrl,
                                isBreaking: false
                            };
                            
                            article.isBreaking = isBreakingNews(article);
                            feedArticles.push(article);
                        }
                    }
                    
                    return feedArticles;
                } catch (error) {
                    console.warn(`Failed to fetch from ${feed.title}:`, error.message);
                    return [];
                }
            });
            
            // Wait for all with timeout
            const feedResults = await Promise.allSettled(feedPromises);
            
            feedResults.forEach(result => {
                if (result.status === 'fulfilled') {
                    articles.push(...result.value);
                }
            });
            
            console.log(`Fetched ${articles.length} articles from feeds`);
            return articles;
        }

        async function generateAISummaries(articles, digestLength, category) {
            const processedArticles = [];
            const batchSize = 5; // Increased batch size for speed
            
            // Get AI provider and settings
            const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            
            // Check if we have the required API key
            const apiKey = aiProvider === 'gemini' ? geminiApiKey : openaiApiKey;
            if (!apiKey) {
                throw new Error(`Please configure your ${aiProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API key in settings`);
            }
            
            // Get AI rewrite settings
            const aiRewrite = localStorage.getItem('aiRewrite') === 'true';
            const aiStyle = localStorage.getItem('aiStyle') || 'conversational';
            const addContext = localStorage.getItem('addContext') !== 'false';
            const includeImpact = localStorage.getItem('includeImpact') !== 'false';
            const addQuestions = localStorage.getItem('addQuestions') === 'true';
            
            for (let i = 0; i < articles.length; i += batchSize) {
                const batch = articles.slice(i, i + batchSize);
                const batchPromises = batch.map(async (article) => {
                    try {
                        let prompt;
                        let maxTokens = 200;
                        
                        if (aiRewrite) {
                            // AI Rewrite mode - transform the article completely
                            const styleInstructions = {
                                'professional': 'Write in a professional, neutral tone suitable for business readers.',
                                'conversational': 'Write in a conversational, engaging tone that\'s easy to read.',
                                'analytical': 'Write in an analytical, in-depth style with detailed explanations.',
                                'simple': 'Write in simple, clear language that anyone can understand.'
                            };
                            
                            const lengthInstructions = {
                                'brief': '2-3 paragraphs',
                                'medium': '3-4 paragraphs', 
                                'detailed': '4-5 paragraphs'
                            };
                            
                            prompt = `Rewrite this news story as a ${lengthInstructions[digestLength]} article. ${styleInstructions[aiStyle]}

Original headline: ${article.title}
Original content: ${article.description.substring(0, 600)}

Instructions:
- Create an engaging, well-structured article
- Keep the core facts accurate but improve readability
- Use clear, compelling language
${addContext ? '- Add relevant background context where helpful' : ''}
${includeImpact ? '- Include analysis of potential impacts or implications' : ''}
${addQuestions ? '- End with 1-2 thought-provoking questions for readers' : ''}

Write the complete rewritten article:`;
                            
                            maxTokens = digestLength === 'brief' ? 300 : digestLength === 'medium' ? 500 : 700;
                        } else {
                            // Standard summary mode - keep very concise
                            if (digestLength === 'brief') {
                                prompt = `${article.title}

Write ONE sentence summary. Maximum 10 words.`;
                                maxTokens = 15;
                            } else if (digestLength === 'medium') {
                                prompt = `${article.title}

Write exactly 2 short sentences.`;
                                maxTokens = 50;
                            } else {
                                prompt = `${article.title}

Write exactly 3 sentences.`;
                                maxTokens = 80;
                            }
                        }

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);

                        let response, data, aiContent;

                        if (aiProvider === 'gemini') {
                            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{
                                            text: prompt
                                        }]
                                    }],
                                    generationConfig: {
                                        maxOutputTokens: maxTokens,
                                        temperature: digestLength === 'brief' && !aiRewrite ? 0.1 : (aiRewrite ? 0.7 : 0.3)
                                    }
                                }),
                                signal: controller.signal
                            });

                            if (!response.ok) {
                                throw new Error(`Gemini API Error: ${response.status}`);
                            }

                            data = await response.json();
                            aiContent = data.candidates?.[0]?.content?.parts?.[0]?.text || article.description;
                        } else {
                            // OpenAI API call
                            response = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'gpt-4o', // the newest OpenAI model is "gpt-4o" which was released May 13, 2024. do not change this unless explicitly requested by the user
                                    messages: [{
                                        role: 'user',
                                        content: prompt
                                    }],
                                    max_tokens: maxTokens,
                                    temperature: digestLength === 'brief' && !aiRewrite ? 0.1 : (aiRewrite ? 0.7 : 0.3)
                                }),
                                signal: controller.signal
                            });

                            if (!response.ok) {
                                const errorData = await response.text();
                                console.error('OpenAI API Error:', response.status, errorData);
                                throw new Error(`OpenAI API Error: ${response.status} - ${errorData}`);
                            }

                            data = await response.json();
                            aiContent = data.choices?.[0]?.message?.content || article.description;
                        }

                        clearTimeout(timeoutId);

                        return {
                            ...article,
                            aiSummary: cleanHtmlContent(aiContent),
                            isRewritten: aiRewrite
                        };

                    } catch (error) {
                        console.warn(`AI processing failed for article: ${article.title}`, error.message);
                        return {
                            ...article,
                            aiSummary: article.description || 'Summary unavailable',
                            isRewritten: false
                        };
                    }
                });

                // Process batch with reduced delay
                const batchResults = await Promise.allSettled(batchPromises);
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled') {
                        processedArticles.push(result.value);
                    }
                });

                // Minimal delay between batches
                if (i + batchSize < articles.length) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            return processedArticles;
        }

        function displayArticles(articles) {
            // Store articles globally for category filtering
            window.currentDisplayedArticles = articles;
            
            // Hide welcome section when articles are displayed
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            const container = document.getElementById('newsletterArea');
            const showSourceInfo = localStorage.getItem('showSourceInfo') !== 'false';
            const showCategories = localStorage.getItem('showCategories') !== 'false';
            const viewMode = localStorage.getItem('viewMode') || 'row';

            container.innerHTML = articles.map(article => {
                const breakingClass = article.isBreaking ? 'breaking-news' : '';
                const breakingBadge = article.isBreaking ? '<span class="breaking-tag">Breaking</span>' : '';
                
                if (viewMode === 'row') {
                    // Row view - horizontal layout with image on the left
                    const imageHtml = article.imageUrl ? 
                        `<div class="flex-shrink-0 mr-6">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-32 h-24 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <div class="flex">
                                ${imageHtml}
                                <div class="flex-grow">
                                    <header class="mb-3">
                                        <div class="flex flex-wrap gap-2 mb-2">
                                            ${breakingBadge}
                                            ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                        </div>
                                        <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                            <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                                ${article.title}
                                            </a>
                                        </h2>
                                        ${showSourceInfo ? `
                                        <div class="text-sm text-gray-500">
                                            <span class="feed-source">${article.source}</span>
                                        </div>
                                        ` : ''}
                                    </header>
                                    <div class="flex-grow">
                                        ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                            </svg>
                                            AI Rewritten Story
                                        </div>` : ''}
                                        <div class="text-gray-700 leading-relaxed">
                                            ${article.aiSummary}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                } else {
                    // Grid view - vertical layout with image on top
                    const imageHtml = article.imageUrl ? 
                        `<div class="mb-4">
                            <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover rounded-lg" loading="lazy" onerror="this.style.display='none'">
                        </div>` : '';
                    
                    return `
                        <article class="news-card ${breakingClass} rounded-lg p-6 shadow-sm">
                            <header class="mb-4">
                                <div class="flex flex-wrap gap-2 mb-2">
                                    ${breakingBadge}
                                    ${showCategories ? `<span class="category-tag cursor-pointer hover:bg-blue-200" onclick="filterByCategory('${article.category}')">${article.category}</span>` : ''}
                                </div>
                                <h2 class="text-lg font-semibold text-gray-900 mb-2 leading-tight">
                                    <a href="${article.link}" target="_blank" class="hover:text-blue-600 transition-colors">
                                        ${article.title}
                                    </a>
                                </h2>
                                ${showSourceInfo ? `
                                <div class="text-sm text-gray-500">
                                    <span class="feed-source">${article.source}</span>
                                </div>
                                ` : ''}
                            </header>
                            ${imageHtml}
                            <div class="flex-grow">
                                ${article.isRewritten ? `<div class="text-xs text-blue-600 mb-2 flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                                    </svg>
                                    AI Rewritten Story
                                </div>` : ''}
                                <div class="text-gray-700 leading-relaxed">
                                    ${article.aiSummary}
                                </div>
                            </div>
                            <footer class="mt-4 pt-4 border-t border-gray-100">
                                <p class="text-xs text-gray-400">
                                    Published: ${new Date(article.pubDate).toLocaleDateString()}
                                </p>
                            </footer>
                        </article>
                    `;
                }
            }).join('');
        }

        function quickCategory(categoryName) {
            // Set the category in the dropdown
            document.getElementById('categorySelect').value = categoryName.toLowerCase();
            
            // Hide welcome section and show header controls
            const welcomeSection = document.getElementById('welcomeSection');
            const newsHeader = document.getElementById('newsHeader');
            
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Only show header controls if "All Categories" is selected
            if (categoryName.toLowerCase() === 'all') {
                newsHeader.style.display = 'block';
            }
            
            // Generate newsletter for selected category
            generateNewsletter();
        }

        function startOver() {
            // Show welcome section
            const welcomeSection = document.getElementById('welcomeSection');
            const newsHeader = document.getElementById('newsHeader');
            
            if (welcomeSection) {
                welcomeSection.style.display = 'block';
            }
            
            if (newsHeader) {
                newsHeader.style.display = 'none';
            }
            
            // Clear articles
            document.getElementById('newsletterArea').innerHTML = '';
            document.getElementById('statusMessage').textContent = '';
            
            // Reset category selection
            document.getElementById('categorySelect').value = 'all';
            
            showToast('Ready to start over!', 'info');
        }

        function filterByCategory(categoryName) {
            // Update the category selector
            document.getElementById('categorySelect').value = categoryName.toLowerCase();
            
            // Store current articles for filtering
            const currentArticles = window.currentDisplayedArticles || [];
            
            if (currentArticles.length > 0) {
                // Filter and re-sort articles by the selected category
                const filteredArticles = currentArticles.filter(article => 
                    article.category.toLowerCase() === categoryName.toLowerCase()
                );
                
                const otherArticles = currentArticles.filter(article => 
                    article.category.toLowerCase() !== categoryName.toLowerCase()
                );
                
                // Display selected category articles first, then others
                const reorderedArticles = [...filteredArticles, ...otherArticles];
                displayArticles(reorderedArticles);
                
                showToast(`Filtered by ${categoryName}`, 'info');
            } else {
                // If no current articles, generate new newsletter with this category
                generateNewsletter();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 400);
            }, 4000);
        }
    </script>
</body>
</html>